<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Excel Search Dashboard</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(to right, #f0f8ff, #e6f7ff); color: #333; padding: 30px; }
    h1 { color: #007acc; text-shadow: 1px 1px 2px #ccc; margin-bottom: 5px; }
    .author { color: #888; font-size: 0.8em; margin-top: 0; margin-bottom: 20px; }
    input[type="text"], input[type="password"], select { padding: 10px; margin: 10px 0; border: 2px solid #007acc; border-radius: 5px; width: 300px; }
    button { padding: 10px 15px; margin: 5px; border: none; border-radius: 5px; background-color: #007acc; color: white; cursor: pointer; box-shadow: 1px 1px 5px #aaa; transition: background-color 0.3s ease; }
    button:hover { background-color: #005f99; }
    .hidden { display: none; }
    #results, #adminPanel, #adminLogin { margin-top: 20px; background-color: #f9f9f9; padding: 15px; border-radius: 8px; box-shadow: 0 0 10px #ccc; overflow-x: auto; }
    table { min-width: 800px; width: 100%; border-collapse: collapse; margin-bottom: 10px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background-color: #e0f0ff; font-weight: bold; cursor: pointer; position: relative; }
    th:hover { background-color: #c9e5ff; }
    th::after { content: '‚Üï'; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 0.8em; opacity: 0.5; }
    th.asc::after { content: '‚Üë'; opacity: 1; }
    th.desc::after { content: '‚Üì'; opacity: 1; }
    #timestamp { margin-top: 30px; font-style: italic; color: #555; }
    .error { color: red; margin-top: 5px; }
    /* Improved highlight colors - brighter but text remains visible */
    .highlight-0 { background-color: #FFFF00; font-weight: bold; }  /* Bright Yellow */
    .highlight-1 { background-color: #00FF00; font-weight: bold; }  /* Bright Green */
    .highlight-2 { background-color: #00FFFF; font-weight: bold; }  /* Bright Cyan */
    .highlight-3 { background-color: #FF00FF; font-weight: bold; color: white; }  /* Bright Magenta */
    .highlight-4 { background-color: #FF8000; font-weight: bold; }  /* Bright Orange */
    .highlight-5 { background-color: #FF0080; font-weight: bold; color: white; }  /* Bright Pink */
    .file-selector { margin: 15px 0; }
    .file-selector label { font-weight: bold; display: block; margin-bottom: 5px; }
    .file-nickname { display: flex; align-items: center; margin-bottom: 10px; }
    .file-nickname input { margin-right: 10px; }
    .admin-section { margin-top: 20px; padding: 15px; background-color: #f0f8ff; border-radius: 8px; }
    .admin-tools { margin-top: 20px; padding: 15px; background-color: #fff0f0; border-radius: 8px; }
    .password-prompt { margin-top: 15px; padding: 10px; background-color: #fff9e6; border-radius: 5px; border: 1px solid #ffcc00; }
    .admin-header { text-decoration: underline; text-underline-offset: 5px; margin-bottom: 15px; }
    .selection-controls { margin: 10px 0; }
    .log-row { transition: background-color 0.2s; }
    .log-row:hover { background-color: #f5f5f5; }
    .selected { background-color: #e6f7ff !important; }
    .table-container { position: relative; }
    #selectAllLogs { margin-right: 10px; }
    .selected-files { margin-top: 10px; font-style: italic; color: #555; }
  </style>
</head>
<body>
  <h1>üìä Excel Search Dashboard</h1>
  <p class="author">by Shakeel</p>
  
  <!-- User Authentication Section -->
  <div id="userAuth">
    <h3>üë§ Please Enter Your Name to Continue</h3>
    <input type="text" id="userName" placeholder="Enter your name (letters only)..." />
    <div id="nameError" class="error hidden">Please enter a valid name (letters only, no numbers or special characters)</div>
    <button onclick="setUserName()">Continue</button>
    <button onclick="toggleAdminLogin()">Admin Mode</button>
  </div>
  
  <div id="mainContent" class="hidden">
    <p id="timestamp">Page loaded: <span id="lastUpdated"></span></p>
    
    <!-- File Selection Section -->
    <div id="fileSelector" class="file-selector">
      <label for="fileSelect">üìÅ Select Excel Files to Search:</label>
      <select id="fileSelect">
        <option value="" selected disabled>-- Select files to search --</option>
        <option value="all">All Files</option>
        <!-- Files will be populated here -->
      </select>
      <p id="selectedFiles" class="selected-files">No files selected</p>
    </div>
    
    <input type="text" id="searchInput" placeholder="Search keywords separated by commas..." />
    <button onclick="performSearch()">Search</button>
    <button onclick="toggleAdminLogin()">Admin Mode</button>
    <button onclick="logout()" style="background-color: #ff6b6b;">Logout</button>

    <div id="results" class="hidden">
      <p><strong>Excel Sources Loaded:</strong> <span id="excelUploadDate">Fetching...</span></p>
      <p>Total Matches: <span id="totalMatches">0</span></p>
      <p id="perTermMatches"></p>
      <h3>üîé Search Results</h3>
      
      <div id="resultText"></div>
      <div id="exportButtons" style="margin-top: 15px;">
        <button onclick="exportToExcel()">üìä Export to Excel</button>
        <button onclick="printResults()">üñ®Ô∏è Download as PDF</button>
      </div>
    </div>
  </div>

  <!-- Admin Login - Now appears alongside content -->
  <div id="adminLogin" class="hidden">
    <h3>üîê Admin Login</h3>
    <input type="text" id="adminUser" placeholder="Username" style="display: none;" />
    <input type="password" id="adminPass" placeholder="Password" /><br>
    <button onclick="checkAdminLogin()">Login</button>
    <button onclick="toggleAdminLogin()" style="background-color: #ff6b6b;">Cancel</button>
  </div>

  <!-- Admin Panel - Now appears alongside content -->
  <div id="adminPanel" class="hidden">
    <h3 class="admin-header">üìã Admin Panel - User Activity Logs</h3>
    <button onclick="hideAdminPanel()" style="background-color: #ff6b6b; margin-bottom: 15px;">Close Admin Panel</button>
    
    <div class="admin-tools">
      <h3 class="admin-header">üõ†Ô∏è Admin Tools</h3>
      <button onclick="exportUserLogs()">üìù Export Logs as Text</button>
      <button onclick="showDeleteConfirmation()" style="background-color: #ff6b6b;">üóëÔ∏è Delete Selected Logs</button>
      
      <div class="selection-controls">
        <label><input type="checkbox" id="selectAllLogs" onchange="toggleSelectAllLogs(this.checked)"> Select All</label>
        <button onclick="deleteSelectedLogs()" style="background-color: #ff6b6b; margin-left: 10px;">Delete Selected</button>
      </div>
      
      <div id="deleteConfirmation" class="password-prompt hidden">
        <h4>Confirm Deletion</h4>
        <p>This will permanently delete all selected user logs. This action cannot be undone.</p>
        <input type="password" id="deletePassword" placeholder="Enter admin password to confirm" />
        <button onclick="deleteAllLogs()" style="background-color: #ff6b6b;">Confirm Delete All</button>
        <button onclick="hideDeleteConfirmation()">Cancel</button>
      </div>
    </div>
    
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Select</th>
            <th>User Name</th>
            <th>Login Time</th>
            <th>Logout Time</th>
            <th>Duration</th>
            <th>Search Count</th>
            <th>Last Search</th>
          </tr>
        </thead>
        <tbody id="logTable"></tbody>
      </table>
    </div>

    <!-- Admin File Management Section -->
    <div class="admin-section">
      <h3 class="admin-header">üìÅ File Management - Set Nicknames</h3>
      <div id="fileNicknameManager">
        <!-- File nickname inputs will be populated here -->
      </div>
      <button onclick="saveFileNicknames()">üíæ Save Nicknames</button>
      <button onclick="resetFileNicknames()" style="background-color: #ff6b6b;">üîÑ Reset to Default</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    // Global variables
    let excelData = [];
    let availableFiles = [];
    let fileNicknames = {};
    let searchLogs = [];
    let userSessions = [];
    let currentResults = [];
    let currentUserName = "";
    let currentUserLoginTime = null;
    let userSearchCount = 0;
    let userLastSearch = "";
    const highlightColors = ["highlight-0", "highlight-1", "highlight-2", "highlight-3", "highlight-4", "highlight-5"];
    let sortColumn = null;
    let sortDirection = 'asc';
    let selectedLogs = new Set();

    // Remove file extension from filename
    function removeExtension(filename) {
      return filename.replace(/\.[^/.]+$/, "");
    }

    // Load file nicknames from localStorage or initialize empty object
    function loadFileNicknames() {
      const savedNicknames = localStorage.getItem('fileNicknames');
      if (savedNicknames) {
        fileNicknames = JSON.parse(savedNicknames);
      } else {
        fileNicknames = {};
      }
    }

    // Save file nicknames to localStorage
    function saveFileNicknames() {
      // Collect all nickname inputs
      const nicknameInputs = document.querySelectorAll('.nickname-input');
      nicknameInputs.forEach(input => {
        const filename = input.dataset.filename;
        const nickname = input.value.trim();
        if (nickname) {
          fileNicknames[filename] = nickname;
        } else {
          // If nickname is empty, remove it from the object
          delete fileNicknames[filename];
        }
      });
      
      // Save to localStorage
      localStorage.setItem('fileNicknames', JSON.stringify(fileNicknames));
      alert("File nicknames saved successfully!");
      
      // Update the file dropdown
      updateFileDropdown();
    }

    // Reset file nicknames to default (empty)
    function resetFileNicknames() {
      if (confirm("Are you sure you want to reset all file nicknames to their default names?")) {
        fileNicknames = {};
        localStorage.removeItem('fileNicknames');
        renderFileNicknameManager();
        updateFileDropdown();
        alert("File nicknames have been reset to default.");
      }
    }

    // Update the file selection dropdown with nicknames
    function updateFileDropdown() {
      const fileSelect = document.getElementById("fileSelect");
      
      // Clear existing options except the first two
      while (fileSelect.options.length > 2) {
        fileSelect.remove(2);
      }
      
      // Add files to dropdown with nicknames if available
      availableFiles.forEach(file => {
        const option = document.createElement("option");
        option.value = file.name;
        
        // Use nickname if available, otherwise use filename without extension
        const displayName = fileNicknames[file.name] || removeExtension(file.name);
        option.textContent = displayName;
        
        fileSelect.appendChild(option);
      });
    }

    // Update selected files display
    function updateSelectedFilesDisplay() {
      const fileSelect = document.getElementById("fileSelect");
      const selectedFilesElement = document.getElementById("selectedFiles");
      
      if (fileSelect.value === "all") {
        selectedFilesElement.textContent = "All files selected";
      } else if (fileSelect.value) {
        const displayName = fileNicknames[fileSelect.value] || removeExtension(fileSelect.value);
        selectedFilesElement.textContent = `Selected: ${displayName}`;
      } else {
        selectedFilesElement.textContent = "No files selected";
      }
    }

    // Render the file nickname manager in the admin panel
    function renderFileNicknameManager() {
      const manager = document.getElementById("fileNicknameManager");
      manager.innerHTML = "";
      
      if (availableFiles.length === 0) {
        manager.innerHTML = "<p>No files available to manage.</p>";
        return;
      }
      
      availableFiles.forEach(file => {
        const div = document.createElement("div");
        div.className = "file-nickname";
        
        const label = document.createElement("label");
        label.textContent = removeExtension(file.name) + ":";
        label.style.minWidth = "150px";
        
        const input = document.createElement("input");
        input.type = "text";
        input.className = "nickname-input";
        input.dataset.filename = file.name;
        input.value = fileNicknames[file.name] || "";
        input.placeholder = "Enter nickname for " + removeExtension(file.name);
        
        div.appendChild(label);
        div.appendChild(input);
        manager.appendChild(div);
      });
    }

    // Show delete confirmation dialog
    function showDeleteConfirmation() {
      document.getElementById('deleteConfirmation').classList.remove('hidden');
      document.getElementById('deletePassword').focus();
    }

    // Hide delete confirmation dialog
    function hideDeleteConfirmation() {
      document.getElementById('deleteConfirmation').classList.add('hidden');
      document.getElementById('deletePassword').value = '';
    }

    // Delete all logs after password confirmation
    function deleteAllLogs() {
      const password = document.getElementById('deletePassword').value.trim();
      
      if (password !== "9332") {
        alert("Incorrect admin password. Deletion cancelled.");
        hideDeleteConfirmation();
        return;
      }
      
      // Clear all logs
      userSessions = [];
      searchLogs = [];
      selectedLogs.clear();
      
      // Update UI
      loadLogs();
      hideDeleteConfirmation();
      alert("All logs have been deleted successfully.");
    }

    // Toggle selection of all logs
    function toggleSelectAllLogs(selectAll) {
      const checkboxes = document.querySelectorAll('.log-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
        const index = parseInt(checkbox.dataset.index);
        if (selectAll) {
          selectedLogs.add(index);
        } else {
          selectedLogs.delete(index);
        }
      });
      
      // Update row styling
      document.querySelectorAll('.log-row').forEach((row, idx) => {
        if (selectAll) {
          row.classList.add('selected');
        } else {
          row.classList.remove('selected');
        }
      });
    }

    // Toggle selection of individual log
    function toggleLogSelection(checkbox, index) {
      if (checkbox.checked) {
        selectedLogs.add(index);
        checkbox.parentElement.parentElement.classList.add('selected');
      } else {
        selectedLogs.delete(index);
        checkbox.parentElement.parentElement.classList.remove('selected');
      }
      
      // Update select all checkbox
      const selectAll = document.getElementById('selectAllLogs');
      selectAll.checked = selectedLogs.size === userSessions.length;
    }

    // Delete selected logs
    function deleteSelectedLogs() {
      if (selectedLogs.size === 0) {
        alert("Please select at least one log to delete.");
        return;
      }
      
      if (!confirm(`Are you sure you want to delete ${selectedLogs.size} log(s)? This action cannot be undone.`)) {
        return;
      }
      
      // Delete selected logs (in reverse order to avoid index issues)
      const sortedIndexes = Array.from(selectedLogs).sort((a, b) => b - a);
      sortedIndexes.forEach(index => {
        userSessions.splice(index, 1);
      });
      
      // Clear selection
      selectedLogs.clear();
      document.getElementById('selectAllLogs').checked = false;
      
      // Update UI
      loadLogs();
      alert(`${sortedIndexes.length} log(s) have been deleted successfully.`);
    }

    // Export user logs as text file
    function exportUserLogs() {
      if (userSessions.length === 0) {
        alert("No user logs available to export.");
        return;
      }
      
      let textContent = "USER LOGIN HISTORY REPORT\n";
      textContent += "Generated on: " + new Date().toLocaleString() + "\n";
      textContent += "Total records: " + userSessions.length + "\n\n";
      
      textContent += "USER SESSIONS:\n";
      textContent += "==============\n\n";
      
      userSessions.forEach((session, index) => {
        textContent += `RECORD ${index + 1}:\n`;
        textContent += `User: ${session.user}\n`;
        textContent += `Login Time: ${session.loginTime ? session.loginTime.toLocaleString() : "N/A"}\n`;
        textContent += `Logout Time: ${session.logoutTime ? session.logoutTime.toLocaleString() : "Still logged in"}\n`;
        textContent += `Duration: ${session.duration ? formatDuration(session.duration) : "N/A"}\n`;
        textContent += `Search Count: ${session.searchCount || 0}\n`;
        textContent += `Last Search: ${session.lastSearch || "No searches"}\n`;
        textContent += "----------------------------------------\n\n";
      });
      
      // Create download link
      const blob = new Blob([textContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'user_logs_report.txt';
      document.body.appendChild(a);
      a.click();
      
      // Clean up
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    }

    function validateName(name) {
      // Only allow letters and spaces, no numbers or special characters
      return /^[A-Za-z\s]+$/.test(name);
    }

    function setUserName() {
      const userName = document.getElementById("userName").value.trim();
      const nameError = document.getElementById("nameError");
      
      if (!userName) {
        nameError.textContent = "Please enter your name";
        nameError.classList.remove("hidden");
        return;
      }
      
      if (!validateName(userName)) {
        nameError.textContent = "Please enter a valid name (letters only, no numbers or special characters)";
        nameError.classList.remove("hidden");
        return;
      }
      
      nameError.classList.add("hidden");
      currentUserName = userName;
      currentUserLoginTime = new Date();
      userSearchCount = 0;
      userLastSearch = "";
      
      document.getElementById("userAuth").classList.add("hidden");
      document.getElementById("mainContent").classList.remove("hidden");
      
      // Store user session
      userSessions.push({
        user: userName,
        loginTime: currentUserLoginTime,
        logoutTime: null,
        searchCount: 0,
        lastSearch: ""
      });
      
      // Focus on search input for immediate use
      document.getElementById("searchInput").focus();
    }
    
    function logout() {
      if (currentUserName && currentUserLoginTime) {
        const logoutTime = new Date();
        const duration = Math.round((logoutTime - currentUserLoginTime) / 1000); // in seconds
        
        // Update the user session with logout time
        const currentSession = userSessions.find(session => 
          session.user === currentUserName && session.logoutTime === null
        );
        
        if (currentSession) {
          currentSession.logoutTime = logoutTime;
          currentSession.duration = duration;
          currentSession.searchCount = userSearchCount;
          currentSession.lastSearch = userLastSearch;
        }
      }
      
      currentUserName = "";
      currentUserLoginTime = null;
      userSearchCount = 0;
      userLastSearch = "";
      
      document.getElementById("userAuth").classList.remove("hidden");
      document.getElementById("mainContent").classList.add("hidden");
      document.getElementById("adminLogin").classList.add("hidden");
      document.getElementById("adminPanel").classList.add("hidden");
      document.getElementById("userName").value = "";
      document.getElementById("userName").focus();
    }

    function toggleAdminLogin() {
      const adminLogin = document.getElementById("adminLogin");
      
      if (adminLogin.classList.contains("hidden")) {
        // Show admin login - don't hide other content
        adminLogin.classList.remove("hidden");
        
        // Clear previous inputs
        document.getElementById("adminUser").value = "shakeel"; // Pre-fill with username
        document.getElementById("adminPass").value = "";
        
        // Focus on password field
        document.getElementById("adminPass").focus();
      } else {
        // Hide admin login
        adminLogin.classList.add("hidden");
      }
    }
    
    function hideAdminPanel() {
      document.getElementById("adminPanel").classList.add("hidden");
      hideDeleteConfirmation();
    }

    async function loadAvailableFiles() {
      try {
        // Use GitHub API to list files in the NEW repository
        const response = await fetch("https://api.github.com/repos/shakeelsnu/FleetData-by-Shakeel/contents/");
        const files = await response.json();
        
        // Filter for Excel files
        availableFiles = files.filter(f => f.name.endsWith(".xlsx"));
        
        // Update the file selection dropdown
        updateFileDropdown();
        
        return availableFiles;
      } catch (error) {
        console.error("Error loading available files:", error);
        document.getElementById("excelUploadDate").innerText = "‚ùå Failed to load file list";
        return [];
      }
    }

    async function loadSelectedExcelFiles() {
      const fileSelect = document.getElementById("fileSelect");
      const selectedValue = fileSelect.value;
      
      if (!selectedValue) {
        alert("Please select a file to search.");
        return;
      }
      
      // If "All Files" is selected
      const loadAll = selectedValue === "all";
      
      const filesToLoad = loadAll ? availableFiles : availableFiles.filter(f => f.name === selectedValue);
      
      excelData = [];
      let loadedNames = [];

      for (const file of filesToLoad) {
        try {
          // Get the raw file content from the NEW repository
          const rawUrl = `https://raw.githubusercontent.com/shakeelsnu/FleetData-by-Shakeel/main/${file.name}`;
          const res = await fetch(rawUrl);
          const arrayBuffer = await res.arrayBuffer();
          const workbook = XLSX.read(arrayBuffer, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet);
          
          // Add filename to each row for tracking
          const rowsWithSource = rows.map(row => ({ ...row, __sourceFile: file.name }));
          excelData = excelData.concat(rowsWithSource);
          
          // Use nickname if available, otherwise use filename without extension
          const displayName = fileNicknames[file.name] || removeExtension(file.name);
          loadedNames.push(displayName);
        } catch (err) { 
          console.error("Failed loading:", file.name, err); 
        }
      }

      document.getElementById("excelUploadDate").innerText = loadedNames.length > 0 ? 
        loadedNames.join(", ") + " loaded at " + new Date().toLocaleString() : 
        "‚ùå No Excel files found or selected";
    }

    async function getClientIP() {
      try { 
        const response = await fetch("https://api.ipify.org?format=json"); 
        const data = await response.json(); 
        return data.ip; 
      } catch (e) { 
        return "IP not available"; 
      }
    }
    
    function getDeviceName() { 
      return navigator.userAgent || "Device name not available"; 
    }

    async function performSearch() {
      // Check if user is logged in
      if (!currentUserName) {
        alert("Please enter your name to search.");
        return;
      }
      
      // First load the selected files
      await loadSelectedExcelFiles();
      
      const input = document.getElementById("searchInput").value.trim();
      const resultText = document.getElementById("resultText");
      const resultsContainer = document.getElementById("results");
      
      if (!input) { 
        resultText.innerHTML = "<p>Please type something to search.</p>"; 
        resultsContainer.classList.remove("hidden"); 
        document.getElementById("totalMatches").innerText = "0"; 
        document.getElementById("perTermMatches").innerText = ""; 
        return; 
      }

      const terms = input.split(",").map(term => term.trim().toLowerCase());
      
      if (excelData.length === 0) { 
        resultText.innerHTML = "<p>No data loaded from GitHub.</p>"; 
        resultsContainer.classList.remove("hidden"); 
        return; 
      }

      currentResults = [];
      let totalMatches = 0;
      const matchesPerTerm = new Map();
      let lineNo = 1;

      excelData.forEach(row => {
        let rowMatched = false;
        let formattedRow = { lineNo: lineNo };
        let rowData = {};

        // Add line number to row data
        rowData['Line No'] = lineNo;
        
        // Use nickname if available, otherwise use filename without extension
        const sourceFileName = row.__sourceFile || 'Unknown';
        const displaySource = fileNicknames[sourceFileName] || removeExtension(sourceFileName);
        rowData['Source File'] = displaySource;
        
        Object.keys(row).forEach(key => {
          // Skip the internal source file property
          if (key === '__sourceFile') return;
          
          let cell = String(row[key] || "");
          let originalCell = cell;
          
          terms.forEach((term, idx) => {
            const regex = new RegExp(`(${term})`, "gi");
            if (regex.test(cell)) {
              rowMatched = true;
              cell = cell.replace(regex, `<span class='${highlightColors[idx % highlightColors.length]}'>$1</span>`);
              matchesPerTerm.set(term, (matchesPerTerm.get(term) || 0) + 1);
              totalMatches++;
            }
          });
          
          rowData[key] = cell;
          formattedRow[key] = originalCell; // Store original value for sorting
        });
        
        if (rowMatched) {
          currentResults.push({ display: rowData, sortData: formattedRow, lineNo: lineNo });
          lineNo++;
        }
      });

      document.getElementById("totalMatches").innerText = totalMatches;

      if (matchesPerTerm.size > 0) {
        const termStrings = [];
        matchesPerTerm.forEach((count, term) => {
          const colorClass = highlightColors[terms.indexOf(term) % highlightColors.length];
          termStrings.push(`<span class='${colorClass}'><b>${term}</b></span>: ${count}`);
        });
        document.getElementById("perTermMatches").innerHTML = "Matches per keyword: " + termStrings.join(", ");
      } else { 
        document.getElementById("perTermMatches").innerHTML = "No keywords matched."; 
      }

      renderResultsTable();
      resultsContainer.classList.remove("hidden");

      const ip = await getClientIP();
      const device = getDeviceName();
      searchLogs.push({ user: currentUserName, ip, device, time: new Date().toLocaleString(), query: input });
      
      // Update user search stats
      userSearchCount++;
      userLastSearch = input;
    }

    function renderResultsTable() {
      const resultText = document.getElementById("resultText");
      
      if (currentResults.length === 0) {
        resultText.innerHTML = "<p>No matches found.</p>";
        return;
      }
      
      // Get column headers from first result, including Source File
      const headers = ['Line No', 'Source File', ...Object.keys(currentResults[0].sortData)
        .filter(key => key !== 'lineNo' && key !== '__sourceFile')];
      
      let tableHtml = `<table><thead><tr>`;
      headers.forEach(header => {
        const isSorted = header === sortColumn;
        const sortClass = isSorted ? (sortDirection === 'asc' ? 'asc' : 'desc') : '';
        tableHtml += `<th class="${sortClass}" onclick="sortTable('${header}')">${header}</th>`;
      });
      tableHtml += `</tr></thead><tbody>`;
      
      currentResults.forEach((result) => {
        tableHtml += `<tr>`;
        headers.forEach(header => {
          if (header === 'Line No') {
            tableHtml += `<td>${result.lineNo}</td>`;
          } else if (header === 'Source File') {
            tableHtml += `<td>${result.display['Source File'] || ''}</td>`;
          } else {
            tableHtml += `<td>${result.display[header] || ''}</td>`;
          }
        });
        tableHtml += `</tr>`;
      });
      
      tableHtml += `</tbody></table>`;
      resultText.innerHTML = tableHtml;
    }

    function sortTable(column) {
      if (sortColumn === column) {
        // Toggle direction if same column clicked again
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'asc';
      }
      
      currentResults.sort((a, b) => {
        let valueA, valueB;
        
        if (column === 'Line No') {
          valueA = a.lineNo;
          valueB = b.lineNo;
        } else if (column === 'Source File') {
            valueA = a.display['Source File'] || '';
            valueB = b.display['Source File'] || '';
        } else {
          valueA = a.sortData[column] || '';
          valueB = b.sortData[column] || '';
        }
        
        // Convert to numbers if possible for proper numeric sorting
        if (!isNaN(valueA) && !isNaN(valueB) && valueA !== '' && valueB !== '') {
          valueA = parseFloat(valueA);
          valueB = parseFloat(valueB);
        }
        
        if (valueA < valueB) return sortDirection === 'asc' ? -1 : 1;
        if (valueA > valueB) return sortDirection === 'asc' ? 1 : -1;
        return 0;
      });
      
      renderResultsTable();
    }

    function exportToExcel() { 
      if (currentResults.length === 0) { 
        alert("No results to export."); 
        return; 
      } 
      
      const workbook = XLSX.utils.book_new(); 
      const headers = ['Line No', 'Source File', ...Object.keys(currentResults[0].sortData)
        .filter(key => key !== 'lineNo' && key !== '__sourceFile')];
      
      // Prepare data for export (using original values without HTML formatting)
      const exportData = currentResults.map(result => {
        const row = {
          'Line No': result.lineNo,
          'Source File': result.display['Source File'] || ''
        };
        
        headers.forEach(header => {
          if (header !== 'Line No' && header !== 'Source File') {
            // Remove HTML tags for clean export
            row[header] = String(result.sortData[header] || '').replace(/<[^>]*>/g, '');
          }
        });
        return row;
      });
      
      const worksheet = XLSX.utils.json_to_sheet(exportData);
      XLSX.utils.book_append_sheet(workbook, worksheet, "Search Results"); 
      XLSX.writeFile(workbook, "search_results.xlsx"); 
    }

    function printResults() { 
      const printWindow = window.open("", "", "width=800,height=600"); 
      const content = document.getElementById("resultText").innerHTML; 
      printWindow.document.write(`<html><head><title>Search Results</title><style>table { width: 100%; border-collapse: collapse; margin-bottom: 10px; } th, td { border: 1px solid #ddd; padding: 12px; text-align: left; } th { background-color: #e0f0ff; font-weight: bold; } .highlight-0 { background-color: #FFFF00; font-weight: bold; } .highlight-1 { background-color: #00FF00; font-weight: bold; } .highlight-2 { background-color: #00FFFF; font-weight: bold; } .highlight-3 { background-color: #FF00FF; font-weight: bold; color: white; } .highlight-4 { background-color: #FF8000; font-weight: bold; } .highlight-5 { background-color: #FF0080; font-weight: bold; color: white; }</style></head><body><h3>Search Results</h3>${content}</body></html>`); 
      printWindow.document.close(); 
      printWindow.focus(); 
      printWindow.print(); 
    }

    function checkAdminLogin() { 
      const user = "shakeel"; // Hardcoded username (case-insensitive)
      const pass = document.getElementById("adminPass").value.trim(); 
      
      // Case-insensitive username check for "shakeel"
      if (pass === "9332") { 
        document.getElementById("adminLogin").classList.add("hidden"); 
        document.getElementById("adminPanel").classList.remove("hidden"); 
        loadLogs(); 
        renderFileNicknameManager();
      } else { 
        alert("Invalid credentials!"); 
      } 
    }

    function formatDuration(seconds) {
      if (!seconds) return "N/A";
      
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      
      if (hours > 0) {
        return `${hours}h ${minutes}m ${secs}s`;
      } else if (minutes > 0) {
        return `${minutes}m ${secs}s`;
      } else {
        return `${secs}s`;
      }
    }

    function loadLogs() { 
      const logTable = document.getElementById("logTable"); 
      logTable.innerHTML = ""; 
      
      userSessions.forEach((session, index) => {
        const loginTime = session.loginTime ? session.loginTime.toLocaleString() : "N/A";
        const logoutTime = session.logoutTime ? session.logoutTime.toLocaleString() : "Still logged in";
        const duration = session.duration ? formatDuration(session.duration) : "N/A";
        const searchCount = session.searchCount || 0;
        const lastSearch = session.lastSearch || "No searches";
        
        const isSelected = selectedLogs.has(index);
        
        logTable.innerHTML += `
          <tr class="log-row ${isSelected ? 'selected' : ''}">
            <td><input type="checkbox" class="log-checkbox" data-index="${index}" ${isSelected ? 'checked' : ''} onchange="toggleLogSelection(this, ${index})"></td>
            <td>${session.user}</td>
            <td>${loginTime}</td>
            <td>${logoutTime}</td>
            <td>${duration}</td>
            <td>${searchCount}</td>
            <td>${lastSearch}</td>
          </tr>
        `;
      }); 
    }

    // Initialize the application
    window.onload = async function() { 
      document.getElementById("lastUpdated").innerText = new Date().toLocaleString(); 
      
      // Load file nicknames from localStorage
      loadFileNicknames();
      
      // Load available files from GitHub
      await loadAvailableFiles();
      
      // Add event listener for file selection change
      document.getElementById("fileSelect").addEventListener("change", updateSelectedFilesDisplay);
      
      // Add keyboard event listeners
      document.getElementById("userName").addEventListener("keypress", function(e) { 
        if (e.key === "Enter") setUserName(); 
      });
      
      document.getElementById("searchInput").addEventListener("keypress", function(e) { 
        if (e.key === "Enter") performSearch(); 
      }); 

      document.getElementById("adminPass").addEventListener("keypress", function(e) { 
        if (e.key === "Enter") checkAdminLogin(); 
      }); 

      document.getElementById("deletePassword").addEventListener("keypress", function(e) { 
        if (e.key === "Enter") deleteAllLogs(); 
      }); 
    };
  </script>
</body>
</html>
