<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Excel Search Dashboard</title>
  <style>
    :root {
      --primary-color: #007acc;
      --secondary-color: #005f99;
      --danger-color: #f44336;
      --success-color: #4caf50;
      --warning-color: #ff9800;
      --border-radius: 8px;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, #f0f8ff, #e6f7ff);
      color: #333;
      padding: 15px;
      margin: 0;
      line-height: 1.6;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: var(--primary-color);
      text-shadow: 1px 1px 2px #ccc;
      margin-bottom: 5px;
      font-size: 2rem;
    }
    .author {
      color: #888;
      font-size: 0.9em;
      margin-top: 0;
      margin-bottom: 20px;
    }
    input[type="text"], input[type="password"], select, .small-input {
      padding: 12px;
      margin: 10px 0;
      border: 2px solid var(--primary-color);
      border-radius: var(--border-radius);
      box-sizing: border-box;
      max-width: 300px;
      width: 100%;
      transition: var(--transition);
      font-size: 1rem;
    }
    input[type="text"]:focus, input[type="password"]:focus, select:focus, .small-input:focus {
      border-color: var(--secondary-color);
      box-shadow: 0 0 8px rgba(0, 122, 204, 0.2);
      outline: none;
    }
    .button-group, .small-button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
      justify-content: flex-start;
      width: auto;
    }
    button, .file-select-container label {
      background-color: var(--primary-color);
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1rem;
      transition: var(--transition);
      flex-grow: 0;
      width: auto;
    }
    button:hover, .file-select-container label:hover {
      background-color: var(--secondary-color);
      transform: translateY(-2px);
      box-shadow: var(--box-shadow);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    .logout-btn {
      background-color: var(--danger-color);
    }
    .logout-btn:hover {
      background-color: #d32f2f;
    }
    .section-viewer {
      width: 100%;
      height: 60vh;
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      margin-top: 20px;
      overflow-y: auto;
      background-color: white;
      box-shadow: var(--box-shadow);
      position: relative;
    }
    .file-select-container {
      position: relative;
      display: inline-block;
      width: 100%;
      max-width: 300px;
    }
    .file-select-container select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background: white url('data:image/svg+xml;utf8,<svg fill="%23007acc" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>') no-repeat right 12px center;
      background-size: 20px;
      padding-right: 40px;
    }
    .search-section {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 20px;
    }
    .search-section input {
      flex-grow: 1;
      max-width: none;
      width: auto;
    }
    .search-section button {
      flex-grow: 0;
      width: auto;
    }
    .results-section {
      margin-top: 20px;
    }
    .results-section h3 {
      color: var(--primary-color);
      font-size: 1.2rem;
    }
    #searchResults, #adminLogs, #adminFiles {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.9em;
    }
    #searchResults th, #adminLogs th, #adminFiles th {
      background-color: var(--primary-color);
      color: white;
      padding: 12px;
      text-align: left;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    #searchResults td, #adminLogs td, #adminFiles td {
      border: 1px solid #ddd;
      padding: 10px;
      word-wrap: break-word;
      min-width: 100px;
      position: relative;
    }
    .no-results {
      color: #e53935;
      font-weight: bold;
      text-align: center;
      padding: 20px;
    }
    .tab-container {
      display: flex;
      border-bottom: 2px solid var(--primary-color);
      margin-bottom: 20px;
      background-color: #f0f8ff;
    }
    .tab-button {
      background-color: transparent;
      border: none;
      padding: 15px 25px;
      cursor: pointer;
      font-size: 1rem;
      color: #555;
      position: relative;
      top: 2px;
    }
    .tab-button.active {
      background-color: white;
      border-top: 2px solid var(--primary-color);
      border-left: 2px solid var(--primary-color);
      border-right: 2px solid var(--primary-color);
      border-bottom: 2px solid white;
      border-top-left-radius: var(--border-radius);
      border-top-right-radius: var(--border-radius);
      color: var(--primary-color);
      font-weight: bold;
    }
    .tab-content {
      padding: 20px;
      border: 2px solid var(--primary-color);
      border-top: none;
      border-radius: 0 0 var(--border-radius) var(--border-radius);
      background-color: white;
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .log-entry.selected {
      background-color: #e6f7ff;
    }
    .logs-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .log-counter {
      font-size: 0.9em;
      color: #555;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
      padding-top: 60px;
    }
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }
    .modal-content h2 {
      color: var(--primary-color);
      margin-top: 0;
    }
    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close-button:hover,
    .close-button:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
    .resizable-th {
      position: relative;
    }
    .resizer {
      position: absolute;
      right: 0;
      top: 0;
      width: 5px;
      height: 100%;
      background: rgba(255, 255, 255, 0.2);
      cursor: col-resize;
      user-select: none;
    }
    .resizer:hover {
      background: #fff;
    }
    th.resizing {
      cursor: col-resize;
    }
    .status-message {
      margin-top: 15px;
      padding: 10px;
      border-radius: var(--border-radius);
      font-weight: bold;
      text-align: center;
    }
    .status-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status-info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .spinner {
      border: 4px solid rgba(0, 122, 204, 0.1);
      border-left-color: var(--primary-color);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      display: none;
      margin-left: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .delete-log-btn {
      position: absolute;
      top: 50%;
      right: 5px;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #ff4d4f;
      font-size: 1.2rem;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .log-entry:hover .delete-log-btn {
      opacity: 1;
    }
    .admin-config-panel {
      margin-top: 20px;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      background-color: #f9f9f9;
      width: fit-content;
      max-width: 400px;
    }
    .admin-config-panel h4 {
      margin-top: 0;
      color: var(--primary-color);
    }
    .admin-config-panel label {
      display: block;
      margin-top: 10px;
    }
    .admin-config-panel input[type="text"], .admin-config-panel input[type="color"] {
      width: 100%;
    }
    .config-button-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    .log-entry.selected {
      background-color: #e6f7ff;
    }
    .input-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .input-row input {
      flex-grow: 1;
      max-width: none;
      width: auto;
    }
    .input-row button {
      flex-grow: 0;
      width: auto;
    }
    .admin-input-group {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 5px;
      margin-top: 10px;
    }
    .admin-input-group input {
      width: 300px;
      max-width: 100%;
    }
    .admin-files-viewer-container {
      width: 100%;
      max-width: 500px;
    }
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      gap: 5px;
    }
    .pagination button {
      padding: 8px 12px;
      background-color: #f0f0f0;
      color: #333;
      border: 1px solid #ddd;
    }
    .pagination button.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px;
      border-radius: var(--border-radius);
      color: white;
      z-index: 1001;
      opacity: 0;
      transform: translateX(100%);
      transition: opacity 0.5s, transform 0.5s;
    }
    .notification.success {
      background-color: var(--success-color);
    }
    .notification.error {
      background-color: var(--danger-color);
    }
    .notification.show {
      opacity: 1;
      transform: translateX(0);
    }
    @media (max-width: 768px) {
      .input-row {
        flex-direction: column;
        align-items: stretch;
      }
      .input-row input {
        max-width: 100%;
      }
      .button-group, .small-button-group {
        flex-direction: column;
      }
      .tab-button {
        padding: 10px 15px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <header>
      <h1>Excel Search Dashboard</h1>
      <p class="author">A simple tool for searching and managing Excel data. Copyright M. Shakeel.</p>
    </header>

    <div class="tab-container">
      <button class="tab-button active" onclick="openTab(event, 'main-search-tab')">Search</button>
      <button class="tab-button" onclick="openTab(event, 'admin-log-tab')">Admin Logs</button>
    </div>

    <div id="main-search-tab" class="tab-content active">
      <div class="user-section">
        <label for="userName">Name:</label>
        <div class="input-row">
          <input type="text" id="userName" placeholder="Enter your name" style="max-width: 33.33%;">
          <button onclick="setUserName()">Set Name</button>
        </div>
        <p id="currentUserDisplay">Current User: N/A</p>
      </div>

      <div class="file-section" style="margin-top: 20px;">
        <label for="fileSelect">Select File:</label>
        <div class="file-select-container">
          <select id="fileSelect" style="max-width: 33.33%;"></select>
        </div>
        <p id="selectedFilesDisplay"></p>
      </div>

      <div class="search-section input-row">
        <input type="text" id="searchInput" placeholder="Enter search term" style="max-width: 33.33%;">
        <button onclick="performSearch()">Search</button>
        <div id="loadingSpinner" class="spinner"></div>
      </div>

      <div class="results-section">
        <h3 id="resultHeader">Search Results:</h3>
        <p id="lastUpdated" style="font-size: 0.8em; color: #666;"></p>
        <div id="excel-viewer" class="section-viewer">
          <table id="searchResults"></table>
        </div>
        <div id="pagination" class="pagination"></div>
      </div>
    </div>

    <div id="admin-log-tab" class="tab-content">
      <div class="admin-login-section">
        <h3>Admin Login</h3>
        <div class="admin-input-group">
          <label for="adminUser">Username:</label>
          <input type="text" id="adminUser" placeholder="Admin username">
          <label for="adminPass">Password:</label>
          <input type="password" id="adminPass" placeholder="Admin password">
        </div>
        <div class="small-button-group">
          <button onclick="checkAdminLogin()">Login</button>
          <button onclick="forgotPassword()">Forgot Password?</button>
        </div>
        <p id="loginMessage"></p>
      </div>

      <div id="admin-view" style="display: none; margin-top: 20px;">
        <div class="small-button-group" style="justify-content: flex-end;">
          <button onclick="logoutAdmin()" class="logout-btn">Logout</button>
        </div>
        <div class="admin-logs-view">
          <h3>Admin Log Viewer</h3>
          <div class="logs-actions">
            <button onclick="deleteSelectedLogs()">Delete Selected</button>
            <button onclick="exportUserLogs()">Export Selected Logs</button>
            <div class="log-counter">Selected: <span id="selectedLogsCount">0</span></div>
          </div>
          <div id="admin-log-viewer" class="section-viewer">
            <table id="adminLogs"></table>
          </div>
          <div class="admin-input-group">
            <label for="deleteAllPassword">Delete All Logs Password:</label>
            <input type="password" id="deleteAllPassword" placeholder="Enter password to delete all logs">
            <button onclick="deleteAllLogs()">Delete All Logs</button>
            <p id="deleteAllMessage"></p>
          </div>
        </div>
        <div class="admin-config-panel">
          <h4>UI Configuration</h4>
          <label for="primaryColor">Primary Color:</label>
          <input type="color" id="primaryColor" value="#007acc">
          <label for="borderRadius">Button Corner Radius (px):</label>
          <input type="number" id="borderRadius" value="8" min="0" max="20" class="small-input">
          <div class="config-button-group">
            <button onclick="applyConfig()">Apply</button>
            <button onclick="saveConfig()">Save</button>
            <button onclick="resetConfig()">Reset</button>
          </div>
        </div>
        <div class="admin-config-panel">
          <h4>Data Source Configuration</h4>
          <label for="fileUrl">Add new Excel File URL:</label>
          <input type="text" id="fileUrl" placeholder="Enter file URL from GitHub" class="small-input">
          <label for="fileName">File Nickname:</label>
          <input type="text" id="fileName" placeholder="Enter nickname" class="small-input">
          <div class="config-button-group">
            <button onclick="addFile()">Add File</button>
          </div>
          <div class="admin-files-viewer-container">
            <div id="admin-files-viewer" class="section-viewer" style="height: 300px;">
              <table id="adminFiles"></table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="messageModal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeModal()">&times;</span>
      <p id="modalMessage"></p>
    </div>
  </div>

  <div id="notification" class="notification"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script type="module">
    // Firebase imports - Updated to latest version
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
      getAuth, 
      signInWithCustomToken, 
      signInAnonymously, 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, 
      doc, 
      getDoc, 
      setDoc, 
      collection, 
      query, 
      where, 
      addDoc, 
      onSnapshot, 
      getDocs, 
      deleteDoc,
      serverTimestamp,
      orderBy
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { 
      getStorage, 
      ref, 
      getDownloadURL 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // Global variables (will be populated by the canvas environment)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app;
    let auth;
    let db;
    let userId;
    let currentUserName = "Unknown";
    let isUserAdmin = false;
    const ADMIN_USER = "Shakeel";
    const ADMIN_PASS = "9332";
    const ADMIN_EMAIL = "shakeelsnu@gmail.com";

    // Firestore paths
    const adminLogsPath = `artifacts/${appId}/public/data/logs`;
    const excelFilesDocPath = `artifacts/${appId}/public/data/excel_files/file_list`;
    const userSearchLogsPath = `artifacts/${appId}/users/${userId}/search_logs`;

    // Search results pagination
    let currentPage = 1;
    const resultsPerPage = 50;
    let allSearchResults = [];

    // Initialize Firebase
    function initializeFirebase() {
      if (Object.keys(firebaseConfig).length === 0) {
        showNotification("Firebase config is missing. Cannot initialize Firebase.", "error");
        return null;
      }
      try {
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        return { app, auth, db };
      } catch (error) {
        console.error("Error initializing Firebase:", error);
        showNotification("Error initializing Firebase. Please check your configuration.", "error");
        return null;
      }
    }

    // Authentication and Initialization
    async function initAuth() {
      const firebaseServices = initializeFirebase();
      if (!firebaseServices) return;
      app = firebaseServices.app;
      auth = firebaseServices.auth;
      db = firebaseServices.db;

      try {
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }
        
        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
            console.log("Authenticated with Firebase. User ID:", userId);
            startLogListener();
            startFileListener();
            
            // Load user name from localStorage if available
            const savedUserName = localStorage.getItem('userName');
            if (savedUserName) {
              currentUserName = savedUserName;
              document.getElementById("userName").value = currentUserName;
              document.getElementById("currentUserDisplay").innerText = `Current User: ${currentUserName}`;
            }
          } else {
            userId = 'anonymous-' + crypto.randomUUID();
            console.log("Signed in anonymously. User ID:", userId);
          }
        });
      } catch (error) {
        console.error("Firebase Authentication failed:", error);
        userId = 'anonymous-' + crypto.randomUUID();
        console.log("Signed in anonymously. User ID:", userId);
        showNotification("Authentication failed. Using anonymous mode.", "error");
      }
    }

    // Notification system
    function showNotification(message, type = "success") {
      const notification = document.getElementById("notification");
      notification.textContent = message;
      notification.className = `notification ${type}`;
      notification.classList.add("show");
      
      setTimeout(() => {
        notification.classList.remove("show");
      }, 3000);
    }

    // Modal functions
    function openModal(message) {
      document.getElementById('modalMessage').innerText = message;
      document.getElementById('messageModal').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('messageModal').style.display = 'none';
    }

    // Log user search activity to Firestore
    async function logSearch(searchTerm) {
      if (!userId || !db) return;
      const userSearchLogsCol = collection(db, `artifacts/${appId}/users/${userId}/search_logs`);
      try {
        await addDoc(userSearchLogsCol, {
          userId: userId,
          userName: currentUserName,
          searchTerm: searchTerm,
          timestamp: serverTimestamp()
        });
      } catch (e) {
        console.error("Error adding search log document:", e);
        showNotification("Error logging search activity.", "error");
      }
    }

    // Log admin actions to a public collection
    async function logAdminAction(action) {
      if (!db) return;
      const adminLogsCol = collection(db, adminLogsPath);
      try {
        await addDoc(adminLogsCol, {
          userId: userId,
          userName: currentUserName,
          action: action,
          timestamp: serverTimestamp()
        });
      } catch (e) {
        console.error("Error adding admin log document:", e);
        showNotification("Error logging admin action.", "error");
      }
    }

    // Handle user name input
    function setUserName() {
      const userNameInput = document.getElementById("userName");
      currentUserName = userNameInput.value.trim() || "Unknown";
      document.getElementById("currentUserDisplay").innerText = `Current User: ${currentUserName}`;
      
      // Save to localStorage
      localStorage.setItem('userName', currentUserName);
      
      showNotification(`User name set to: ${currentUserName}`);
    }

    // Load available files from Firestore (nicknames to URLs)
    async function loadAvailableFiles(files) {
      const fileSelect = document.getElementById("fileSelect");
      fileSelect.innerHTML = '';
      if (files && files.length > 0) {
        files.forEach(file => {
          const option = document.createElement("option");
          option.value = file.url;
          option.innerText = file.name;
          fileSelect.appendChild(option);
        });
      } else {
        const option = document.createElement("option");
        option.innerText = "No files available";
        option.disabled = true;
        fileSelect.appendChild(option);
      }
      updateSelectedFilesDisplay();
    }

    function updateSelectedFilesDisplay() {
      const fileSelect = document.getElementById("fileSelect");
      const selectedOption = fileSelect.options[fileSelect.selectedIndex];
      const selectedFilesDisplay = document.getElementById("selectedFilesDisplay");
      if (selectedOption && selectedOption.value) {
        selectedFilesDisplay.innerText = `Selected file: ${selectedOption.innerText}`;
      } else {
        selectedFilesDisplay.innerText = '';
      }
    }

    // Perform search
    async function performSearch() {
      const fileSelect = document.getElementById("fileSelect");
      const selectedUrl = fileSelect.value;
      const searchInput = document.getElementById("searchInput").value.trim();
      const spinner = document.getElementById("loadingSpinner");
      const resultsTable = document.getElementById("searchResults");
      resultsTable.innerHTML = '';
      document.getElementById("resultHeader").innerText = "Search Results:";
      document.getElementById("pagination").innerHTML = '';
      allSearchResults = [];

      if (!selectedUrl) {
        showNotification("Please select a file first.", "error");
        return;
      }

      if (!searchInput) {
        showNotification("Please enter a search term.", "error");
        return;
      }

      spinner.style.display = 'inline-block';
      await logSearch(searchInput);

      try {
        const response = await fetch(selectedUrl);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        let foundResults = [];

        workbook.SheetNames.forEach(sheetName => {
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          if (jsonData.length === 0) return;
          
          const headers = jsonData[0];
          for (let i = 1; i < jsonData.length; i++) {
            const row = jsonData[i];
            if (!row || row.length === 0) continue;
            
            const rowString = JSON.stringify(row).toLowerCase();
            if (rowString.includes(searchInput.toLowerCase())) {
              const rowObject = {};
              headers.forEach((header, index) => {
                rowObject[header] = row[index];
              });
              foundResults.push(rowObject);
            }
          }
        });

        spinner.style.display = 'none';

        if (foundResults.length > 0) {
          allSearchResults = foundResults;
          displayResults(1); // Show first page
        } else {
          resultsTable.innerHTML = `<tr><td colspan="100%" class="no-results">No results found for "${searchInput}".</td></tr>`;
        }
      } catch (error) {
        spinner.style.display = 'none';
        console.error("Error fetching or processing Excel file:", error);
        showNotification("Failed to load or search the file. Please try again.", "error");
      }
    }

    function displayResults(page) {
      const resultsTable = document.getElementById("searchResults");
      resultsTable.innerHTML = '';
      currentPage = page;
      
      if (allSearchResults.length === 0) {
        resultsTable.innerHTML = `<tr><td colspan="100%" class="no-results">No results to display.</td></tr>`;
        return;
      }

      const totalPages = Math.ceil(allSearchResults.length / resultsPerPage);
      const startIndex = (page - 1) * resultsPerPage;
      const endIndex = Math.min(startIndex + resultsPerPage, allSearchResults.length);
      const pageResults = allSearchResults.slice(startIndex, endIndex);

      const headers = Object.keys(allSearchResults[0]);
      const headerRow = document.createElement("tr");
      headers.forEach(headerText => {
        const th = document.createElement("th");
        th.innerText = headerText;
        headerRow.appendChild(th);
      });
      resultsTable.appendChild(headerRow);

      pageResults.forEach(rowData => {
        const row = document.createElement("tr");
        headers.forEach(header => {
          const cell = document.createElement("td");
          cell.innerText = rowData[header] || '';
          row.appendChild(cell);
        });
        resultsTable.appendChild(row);
      });

      // Add pagination controls
      const paginationDiv = document.getElementById("pagination");
      paginationDiv.innerHTML = '';
      
      if (totalPages > 1) {
        for (let i = 1; i <= totalPages; i++) {
          const pageButton = document.createElement("button");
          pageButton.innerText = i;
          pageButton.classList.add("pagination-button");
          if (i === page) {
            pageButton.classList.add("active");
          }
          pageButton.onclick = () => displayResults(i);
          paginationDiv.appendChild(pageButton);
        }
      }
      
      document.getElementById("resultHeader").innerText = `Search Results: ${allSearchResults.length} found (showing ${startIndex + 1}-${endIndex})`;
    }

    // Admin Log Functions
    function checkAdminLogin() {
      const user = document.getElementById("adminUser").value;
      const pass = document.getElementById("adminPass").value;
      const loginMessage = document.getElementById("loginMessage");
      const adminView = document.getElementById("admin-view");

      if (user.toLowerCase() === ADMIN_USER.toLowerCase() && pass === ADMIN_PASS) {
        loginMessage.innerText = "Login successful!";
        loginMessage.className = "status-message status-success";
        adminView.style.display = 'block';
        isUserAdmin = true;
        logAdminAction("Admin logged in.");
        showNotification("Admin login successful!");
      } else {
        loginMessage.innerText = "Invalid credentials.";
        loginMessage.className = "status-message status-error";
        adminView.style.display = 'none';
        isUserAdmin = false;
      }
    }

    function logoutAdmin() {
      document.getElementById("adminUser").value = '';
      document.getElementById("adminPass").value = '';
      document.getElementById("loginMessage").innerText = '';
      document.getElementById("admin-view").style.display = 'none';
      isUserAdmin = false;
      logAdminAction("Admin logged out.");
      showNotification("You have been logged out of Admin Mode.");
    }

    function forgotPassword() {
      const user = document.getElementById("adminUser").value;
      if (user.toLowerCase() === ADMIN_USER.toLowerCase()) {
        openModal(`A password reset link has been sent to ${ADMIN_EMAIL}.`);
      } else {
        openModal("Please enter the correct username to reset your password.");
      }
    }

    function startLogListener() {
      if (!db) return;
      const logsCol = collection(db, adminLogsPath);
      const q = query(logsCol, orderBy("timestamp", "desc"));
      
      onSnapshot(q, (snapshot) => {
        const logs = [];
        snapshot.forEach((doc) => {
          const logData = doc.data();
          logData.id = doc.id;
          logs.push(logData);
        });
        displayAdminLogs(logs);
      }, (error) => {
        console.error("Error listening to admin logs:", error);
        showNotification("Error loading admin logs.", "error");
      });
    }

    function displayAdminLogs(logs) {
      const adminLogsTable = document.getElementById("adminLogs");
      adminLogsTable.innerHTML = '';

      if (logs.length === 0) {
        adminLogsTable.innerHTML = `<tr><td colspan="100%" class="no-results">No admin logs to display.</td></tr>`;
        return;
      }

      const headers = ["Select", "Timestamp", "User", "Action", "Delete"];
      const headerRow = document.createElement("tr");
      headers.forEach(headerText => {
        const th = document.createElement("th");
        th.className = "resizable-th";
        th.innerText = headerText;
        if (headerText !== "Select" && headerText !== "Delete") {
          const resizer = document.createElement("div");
          resizer.className = "resizer";
          th.appendChild(resizer);
        }
        headerRow.appendChild(th);
      });
      adminLogsTable.appendChild(headerRow);

      logs.forEach(logData => {
        const row = document.createElement("tr");
        row.className = "log-entry";
        row.dataset.docId = logData.id;

        const checkboxCell = document.createElement("td");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.onclick = updateSelectedLogsCount;
        checkboxCell.appendChild(checkbox);
        row.appendChild(checkboxCell);

        const timestampCell = document.createElement("td");
        timestampCell.innerText = logData.timestamp ? new Date(logData.timestamp.toDate()).toLocaleString() : 'N/A';
        row.appendChild(timestampCell);

        const userCell = document.createElement("td");
        userCell.innerText = logData.userName || 'Unknown';
        row.appendChild(userCell);

        const actionCell = document.createElement("td");
        actionCell.innerText = logData.action;
        row.appendChild(actionCell);

        const deleteCell = document.createElement("td");
        const deleteButton = document.createElement("button");
        deleteButton.className = "delete-log-btn";
        deleteButton.innerText = "X";
        deleteButton.onclick = (e) => {
          e.stopPropagation();
          deleteSingleLog(logData.id);
        };
        deleteCell.appendChild(deleteButton);
        row.appendChild(deleteCell);

        row.onclick = (e) => {
          if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
            checkbox.checked = !checkbox.checked;
            updateSelectedLogsCount();
          }
        };

        adminLogsTable.appendChild(row);
      });

      initResizableColumns();
      updateSelectedLogsCount();
    }

    async function deleteSingleLog(docId) {
      if (!isUserAdmin) {
        showNotification("You must be an admin to perform this action.", "error");
        return;
      }
      try {
        await deleteDoc(doc(db, adminLogsPath, docId));
        logAdminAction(`Deleted a single log with ID: ${docId}`);
        showNotification("Log deleted successfully.");
      } catch (e) {
        console.error("Error deleting single log:", e);
        showNotification("An error occurred while deleting the log.", "error");
      }
    }

    function updateSelectedLogsCount() {
      const checkboxes = document.querySelectorAll("#adminLogs input[type='checkbox']");
      const selectedLogsCount = document.getElementById("selectedLogsCount");
      const logsActions = document.querySelector(".logs-actions");
      let count = 0;
      checkboxes.forEach(cb => {
        if (cb.checked) {
          count++;
          cb.closest('tr').classList.add('selected');
        } else {
          cb.closest('tr').classList.remove('selected');
        }
      });
      selectedLogsCount.innerText = count;

      if (count > 0) {
        logsActions.style.display = 'flex';
        logsActions.querySelector('button:first-child').style.display = 'block';
        logsActions.querySelector('button:nth-child(2)').style.display = 'block';
        logsActions.querySelector('.log-counter').style.display = 'block';
      } else {
        logsActions.style.display = 'none';
      }
    }

    async function deleteSelectedLogs() {
      if (!isUserAdmin) {
        showNotification("You must be an admin to perform this action.", "error");
        return;
      }
      const selectedLogs = document.querySelectorAll("#adminLogs input[type='checkbox']:checked");
      if (selectedLogs.length === 0) {
        showNotification("Please select at least one log to delete.", "error");
        return;
      }

      try {
        const deletePromises = [];
        selectedLogs.forEach(cb => {
          const docId = cb.closest('tr').dataset.docId;
          const docRef = doc(db, adminLogsPath, docId);
          deletePromises.push(deleteDoc(docRef));
        });
        await Promise.all(deletePromises);
        logAdminAction(`Deleted ${selectedLogs.length} logs.`);
        showNotification(`${selectedLogs.length} logs deleted successfully.`);
      } catch (e) {
        console.error("Error deleting logs:", e);
        showNotification("An error occurred while deleting logs.", "error");
      }
    }

    async function deleteAllLogs() {
      if (!isUserAdmin) {
        showNotification("You must be an admin to perform this action.", "error");
        return;
      }
      const password = document.getElementById("deleteAllPassword").value;
      if (password !== ADMIN_PASS) {
        showNotification("Incorrect password.", "error");
        return;
      }

      try {
        const logsRef = collection(db, adminLogsPath);
        const querySnapshot = await getDocs(logsRef);
        const deletePromises = [];
        querySnapshot.forEach(docSnapshot => {
          deletePromises.push(deleteDoc(doc(db, adminLogsPath, docSnapshot.id)));
        });
        await Promise.all(deletePromises);
        logAdminAction("Deleted all logs.");
        showNotification("All logs deleted successfully.");
        document.getElementById("deleteAllPassword").value = '';
      } catch (e) {
        console.error("Error deleting all logs:", e);
        showNotification("An error occurred while deleting all logs.", "error");
      }
    }

    function initResizableColumns() {
      const table = document.getElementById("adminLogs");
      const headers = table.querySelectorAll(".resizable-th");
      let currentTh = null;
      let startX = 0;
      let startWidth = 0;

      headers.forEach(header => {
        const resizer = header.querySelector(".resizer");
        if (resizer) {
          resizer.addEventListener("mousedown", (e) => {
            currentTh = header;
            startX = e.pageX;
            startWidth = currentTh.offsetWidth;
            currentTh.classList.add("resizing");
            document.addEventListener("mousemove", resize);
            document.addEventListener("mouseup", stopResize);
          });
        }
      });

      function resize(e) {
        if (currentTh) {
          const newWidth = startWidth + (e.pageX - startX);
          currentTh.style.width = newWidth + "px";
        }
      }

      function stopResize() {
        if (currentTh) {
          currentTh.classList.remove("resizing");
          currentTh = null;
          document.removeEventListener("mousemove", resize);
          document.removeEventListener("mouseup", stopResize);
        }
      }
    }

    function exportUserLogs() {
      const selectedLogs = document.querySelectorAll("#adminLogs tr.log-entry.selected");
      if (selectedLogs.length === 0) {
        showNotification("Please select at least one log to export.", "error");
        return;
      }

      let csv = "Timestamp,User,Action\n";
      selectedLogs.forEach(row => {
        const cells = row.querySelectorAll("td");
        const timestamp = cells[1].innerText.replace(/"/g, '""');
        const user = cells[2].innerText.replace(/"/g, '""');
        const action = cells[3].innerText.replace(/"/g, '""');
        csv += `"${timestamp}","${user}","${action}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", "selected_admin_logs.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      showNotification("Selected logs exported successfully.");
    }

    // UI Configuration functions
    function loadConfig() {
      const savedConfig = JSON.parse(localStorage.getItem('uiConfig')) || {};
      if (savedConfig.primaryColor) {
        document.getElementById('primaryColor').value = savedConfig.primaryColor;
      }
      if (savedConfig.borderRadius) {
        document.getElementById('borderRadius').value = savedConfig.borderRadius;
      }
      applyConfig();
    }

    function applyConfig() {
      const primaryColor = document.getElementById('primaryColor').value;
      const borderRadius = document.getElementById('borderRadius').value;
      document.documentElement.style.setProperty('--primary-color', primaryColor);
      document.documentElement.style.setProperty('--border-radius', `${borderRadius}px`);
    }

    function saveConfig() {
      const primaryColor = document.getElementById('primaryColor').value;
      const borderRadius = document.getElementById('borderRadius').value;
      const config = { primaryColor, borderRadius };
      localStorage.setItem('uiConfig', JSON.stringify(config));
      showNotification("UI configuration saved!");
    }

    function resetConfig() {
      localStorage.removeItem('uiConfig');
      document.getElementById('primaryColor').value = "#007acc";
      document.getElementById('borderRadius').value = "8";
      applyConfig();
      showNotification("UI configuration reset to default.");
    }

    // Data Source Configuration functions
    const GITHUB_REPO_URL = 'https://api.github.com/repos/shakeelsnu/FleetData-by-Shakeel/contents/';

    async function addFile() {
      const fileUrl = document.getElementById('fileUrl').value.trim();
      const fileName = document.getElementById('fileName').value.trim() || 'Untitled';

      if (!fileUrl) {
        showNotification("Please enter a valid file URL.", "error");
        return;
      }
      
      // Convert GitHub URL to raw format
      let rawUrl = fileUrl;
      if (fileUrl.includes('github.com') && !fileUrl.includes('raw.githubusercontent.com')) {
        rawUrl = fileUrl
          .replace('github.com', 'raw.githubusercontent.com')
          .replace('/blob/', '/');
      }

      try {
        const docRef = doc(db, excelFilesDocPath);
        const docSnap = await getDoc(docRef);
        const existingFiles = docSnap.exists() ? docSnap.data().files : [];
        
        // Check if file already exists
        if (existingFiles.some(file => file.url === rawUrl)) {
          showNotification("This file URL already exists in the list.", "error");
          return;
        }
        
        const updatedFiles = [...existingFiles, { url: rawUrl, name: fileName }];
        await setDoc(docRef, { files: updatedFiles });
        document.getElementById('fileUrl').value = '';
        document.getElementById('fileName').value = '';
        logAdminAction(`Added new file: ${fileName}`);
        showNotification("File added successfully!");
      } catch (e) {
        console.error("Error adding file:", e);
        showNotification("An error occurred while adding the file.", "error");
      }
    }

    async function deleteFile(index) {
      if (!isUserAdmin) {
        showNotification("You must be an admin to perform this action.", "error");
        return;
      }
      try {
        const docRef = doc(db, excelFilesDocPath);
        const docSnap = await getDoc(docRef);
        const files = docSnap.exists() ? docSnap.data().files : [];
        const deletedFileName = files[index].name;
        files.splice(index, 1);
        await setDoc(docRef, { files: files });
        logAdminAction(`Deleted file: ${deletedFileName}`);
        showNotification("File deleted successfully.");
      } catch (e) {
        console.error("Error deleting file:", e);
        showNotification("An error occurred while deleting the file.", "error");
      }
    }

    function startFileListener() {
      if (!db) return;
      const docRef = doc(db, excelFilesDocPath);
      onSnapshot(docRef, (docSnap) => {
        const files = docSnap.exists() ? docSnap.data().files : [];
        loadAvailableFiles(files);
        if (isUserAdmin) {
          displayAdminFiles(files);
        }
      }, (error) => {
        console.error("Error listening to files:", error);
        showNotification("Error loading files.", "error");
      });
    }

    function displayAdminFiles(files) {
      const table = document.getElementById("adminFiles");
      table.innerHTML = '';
      if (files.length === 0) {
        table.innerHTML = `<tr><td colspan="100%" class="no-results">No files to display.</td></tr>`;
        return;
      }
      const headerRow = document.createElement("tr");
      headerRow.innerHTML = `<th>File Nickname</th><th>URL</th><th>Actions</th>`;
      table.appendChild(headerRow);
      files.forEach((file, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${file.name}</td>
          <td>${file.url}</td>
          <td><button onclick="deleteFile(${index})">Delete</button></td>
        `;
        table.appendChild(row);
      });
    }

    // Function to handle tab switching, made globally accessible
    function openTab(evt, tabName) {
      const tabContents = document.getElementsByClassName("tab-content");
      for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].style.display = "none";
      }
      const tabButtons = document.getElementsByClassName("tab-button");
      for (let i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove("active");
      }
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.classList.add("active");
    }
    
    // Assign functions to the window object to make them globally available to the HTML `onclick` attributes
    window.openTab = openTab;
    window.setUserName = setUserName;
    window.performSearch = performSearch;
    window.checkAdminLogin = checkAdminLogin;
    window.logoutAdmin = logoutAdmin;
    window.forgotPassword = forgotPassword;
    window.deleteSelectedLogs = deleteSelectedLogs;
    window.exportUserLogs = exportUserLogs;
    window.deleteAllLogs = deleteAllLogs;
    window.closeModal = closeModal;
    window.applyConfig = applyConfig;
    window.saveConfig = saveConfig;
    window.resetConfig = resetConfig;
    window.addFile = addFile;
    window.deleteFile = deleteFile;

    // Initialize the application
    window.onload = async function() {
      await initAuth();
      document.getElementById("lastUpdated").innerText = new Date().toLocaleString();
      loadConfig();

      // Add event listener for file selection change
      document.getElementById("fileSelect").addEventListener("change", updateSelectedFilesDisplay);

      // Add keyboard event listeners
      document.getElementById("userName").addEventListener("keypress", function(e) {
        if (e.key === "Enter") setUserName();
      });
      document.getElementById("searchInput").addEventListener("keypress", function(e) {
        if (e.key === "Enter") performSearch();
      });
      document.getElementById("adminUser").addEventListener("keypress", function(e) {
        if (e.key === "Enter") checkAdminLogin();
      });
      document.getElementById("adminPass").addEventListener("keypress", function(e) {
        if (e.key === "Enter") checkAdminLogin();
      });
      document.getElementById("deleteAllPassword").addEventListener("keypress", function(e) {
        if (e.key === "Enter") deleteAllLogs();
      });
      
      // Close modal when clicking outside
      window.addEventListener('click', function(event) {
        const modal = document.getElementById('messageModal');
        if (event.target === modal) {
          closeModal();
        }
      });
    };
  </script>
</body>
</html>
