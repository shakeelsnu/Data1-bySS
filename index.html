<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Excel Search Dashboard</title>
  <style>
    :root {
      --bg-color: linear-gradient(to right, #f0f8ff, #e6f7ff);
      --text-color: #333;
      --button-color: #007acc;
      --button-hover-color: #005f99;
      --font-family: 'Segoe UI', sans-serif;
      --header-color: #007acc;
      --table-header-bg: #e0f0ff;
      --table-border: #ddd;
      --result-bg: #f9f9f9;
    }
    
    body { 
      font-family: var(--font-family); 
      background: var(--bg-color); 
      color: var(--text-color); 
      padding: 15px; 
      margin: 0;
      transition: all 0.3s ease;
    }
    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 10px;
    }
    h1 { 
      color: var(--header-color); 
      text-shadow: 1px 1px 2px #ccc; 
      margin-bottom: 5px; 
      font-size: 1.8rem;
    }
    .author { 
      color: #888; 
      font-size: 0.9em; 
      margin-top: 0; 
      margin-bottom: 20px; 
    }
    input[type="text"], input[type="password"] { 
      padding: 12px; 
      margin: 10px 0; 
      border: 2px solid var(--button-color); 
      border-radius: 5px; 
      box-sizing: border-box;
      font-size: 16px;
      transition: width 0.3s ease-in-out;
      background: white;
      color: #333;
    }
    #userName {
      width: 150px;
      padding: 8px 12px;
    }
    #userName:focus {
      width: 100%;
    }
    #mainContent h3 {
        font-size: 1.2em;
        margin-bottom: 5px;
    }
    .search-inputs {
        display: flex;
        flex-direction: column;
        gap: 10px;
        flex-wrap: wrap;
    }
    #searchInput {
      width: 250px;
      padding: 8px 12px;
    }
    #searchInput:focus {
      flex: 1;
      width: 100%;
    }
    select#fileSelect {
      padding: 8px 12px;
      margin: 10px 0;
      border: 2px solid var(--button-color);
      border-radius: 5px;
      font-size: 16px;
      background: white;
      color: #333;
    }
    button { 
      padding: 12px 18px; 
      margin: 8px 5px; 
      border: none; 
      border-radius: 5px; 
      background-color: var(--button-color); 
      color: white; 
      cursor: pointer; 
      box-shadow: 1px 1px 5px #aaa; 
      transition: all 0.3s ease; 
      font-size: 16px;
    }
    button:hover { 
      background-color: var(--button-hover-color); 
      transform: translateY(-2px);
      box-shadow: 2px 4px 8px #999;
    }
    .hidden { 
      display: none; 
    }
    #results, #adminPanel, #adminLogin { 
      margin-top: 20px; 
      background-color: var(--result-bg); 
      padding: 20px; 
      border-radius: 8px; 
      box-shadow: 0 0 10px #ccc; 
    }
    table { 
      min-width: 600px;
      border-collapse: collapse; 
      margin-bottom: 10px; 
      width: 100%;
      border: 1px solid var(--table-border);
    }
    th, td { 
      border: 1px solid var(--table-border); 
      padding: 10px; 
      text-align: left; 
      font-size: 0.9rem;
      line-height: 1.3;
      position: relative;
    }
    th { 
      background-color: var(--table-header-bg); 
      font-weight: bold; 
      cursor: pointer; 
      position: relative; 
      white-space: nowrap;
    }
    th:hover { 
      background-color: #c9e5ff; 
    }
    th::after { 
      content: '↕'; 
      position: absolute; 
      right: 8px; 
      top: 50%; 
      transform: translateY(-50%); 
      font-size: 0.8em; 
      opacity: 0.5; 
    }
    th.asc::after { 
      content: '↑'; 
      opacity: 1; 
    }
    th.desc::after { 
      content: '↓'; 
      opacity: 1; 
    }
    .resize-handle {
      display: none;
    }
    #timestamp { 
      margin-top: 30px; 
      font-style: italic; 
      color: #555; 
      font-size: 0.9rem;
    }
    .error { 
      color: red; 
      margin-top: 5px; 
      font-weight: bold;
    }
    /* Improved highlight colors - brighter but text remains visible */
    .highlight-0 { background-color: #FFFF00; font-weight: bold; }  /* Bright Yellow */
    .highlight-1 { background-color: #00FF00; font-weight: bold; }  /* Bright Green */
    .highlight-2 { background-color: #00FFFF; font-weight: bold; }  /* Bright Cyan */
    .highlight-3 { background-color: #FF00FF; font-weight: bold; color: white; }  /* Bright Magenta */
    .highlight-4 { background-color: #FF8000; font-weight: bold; }  /* Bright Orange */
    .highlight-5 { background-color: #FF0080; font-weight: bold; color: white; }  /* Bright Pink */
    .file-selector { 
      margin: 15px 0; 
    }
    .file-selector label { 
      font-weight: bold; 
      display: block; 
      margin-bottom: 5px; 
      font-size: 1.1rem;
    }
    .file-nickname { 
      display: flex; 
      align-items: center; 
      margin-bottom: 10px; 
      flex-wrap: wrap;
    }
    .file-nickname input { 
      margin-right: 10px; 
      flex: 1;
      min-width: 150px;
    }
    .admin-section { 
      margin-top: 20px; 
      padding: 15px; 
      background-color: #f0f8ff; 
      border-radius: 8px; 
    }
    .admin-tools { 
      margin-top: 20px; 
      padding: 15px; 
      background-color: #fff0f0; 
      border-radius: 8px; 
    }
    .password-prompt { 
      margin-top: 15px; 
      padding: 10px; 
      background-color: #fff9e6; 
      border-radius: 5px; 
      border: 1px solid #ffcc00; 
    }
    .admin-header { 
      text-decoration: underline; 
      text-underline-offset: 5px; 
      margin-bottom: 15px; 
      color: #007acc;
      font-size: 1.2rem;
    }
    .selection-controls { 
      margin: 10px 0; 
    }
    .log-row { 
      transition: background-color 0.2s; 
    }
    .log-row:hover { 
      background-color: #f5f5f5; 
    }
    .selected { 
      background-color: #e6f7ff !important; 
    }
    .table-container { 
      position: relative; 
      overflow-x: auto;
      width: 100%;
    }
    #selectAllLogs { 
      margin-right: 10px; 
    }
    .selected-files { 
      margin-top: 10px; 
      font-style: italic; 
      color: #555; 
    }
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0;
    }
    .admin-button {
      background-color: #8e44ad;
    }
    .logout-button {
      background-color: #ff6b6b;
    }
    .search-button {
      background-color: #27ae60;
    }
    .export-button {
      background-color: #9b59b6;
    }
    .export-options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    .delete-selected-container {
      margin-top: 15px;
      padding: 10px;
      background-color: #fff0f0;
      border-radius: 5px;
      border: 1px solid #ff6b6b;
    }
    
    /* Theme Customization Panel */
    #themePanel {
      position: fixed;
      right: -320px;
      top: 0;
      width: 300px;
      height: 100%;
      background: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.2);
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
      transition: right 0.3s ease;
    }
    
    #themePanel.open {
      right: 0;
    }
    
    .theme-option {
      margin-bottom: 15px;
    }
    
    .theme-option label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .theme-toggle {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 1001;
      background-color: var(--button-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .color-preview {
      width: 30px;
      height: 30px;
      display: inline-block;
      border: 1px solid #ccc;
      vertical-align: middle;
      margin-left: 10px;
      border-radius: 4px;
    }
    
    .preset-themes {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 15px;
    }
    
    .preset-theme {
      height: 40px;
      border: 1px solid #ddd;
      cursor: pointer;
      border-radius: 4px;
    }
    
    .preset-theme.light {
      background: linear-gradient(to right, #f0f8ff, #e6f7ff);
    }
    
    .preset-theme.dark {
      background: linear-gradient(to right, #2c3e50, #34495e);
    }
    
    .preset-theme.warm {
      background: linear-gradient(to right, #fff8f0, #fff0e6);
    }
    
    .preset-theme.cool {
      background: linear-gradient(to right, #f0f0ff, #e6e6ff);
    }
    
    .preset-theme.nature {
      background: linear-gradient(to right, #f0fff0, #e6ffe6);
    }
    
    .preset-theme.sunset {
      background: linear-gradient(to right, #fff0f0, #ffe6e6);
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      .search-inputs {
        flex-direction: column;
        gap: 5px;
      }
      
      input[type="text"], input[type="password"], select {
        font-size: 14px;
        padding: 10px;
      }
      
      button {
        width: 100%;
        margin: 5px 0;
        padding: 10px 15px;
        font-size: 14px;
      }
      
      .button-group {
        flex-direction: column;
        gap: 5px;
      }
      
      #results, #adminPanel, #adminLogin {
        padding: 15px;
        margin-top: 15px;
      }
      
      th, td {
        padding: 8px 6px;
        font-size: 0.8rem;
      }
      
      th::after {
        right: 4px;
        font-size: 0.7em;
      }
      
      .admin-header {
        font-size: 1.1rem;
      }
      
      .export-options {
        flex-direction: column;
      }
      
      .resize-handle {
        display: none;
      }
      
      #themePanel {
        width: 85%;
        right: -85%;
      }
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-height: 90%;
        overflow-y: auto;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }
    .close-button:hover,
    .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    .modal-actions {
        margin-top: 20px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    #previewTableContainer {
        max-height: 500px;
        overflow-y: auto;
    }
    .top-buttons {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 10px;
    }
    .refresh-button {
      background-color: #3498db;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-buttons">
      <button onclick="location.reload()" class="refresh-button">🔄 Refresh</button>
    </div>
    <h1>📊 Excel Search Dashboard</h1>
    <p class="author">by The Creator</p>
    
    <div id="userAuth">
      <h3>Please Enter Your Name to Continue</h3>
      <input type="text" id="userName" placeholder="Enter your name (letters only)..." />
      <div id="nameError" class="error hidden">Please enter a valid name (letters only, no numbers or special characters)</div>
      <div class="button-group">
        <button onclick="setUserName()">Continue</button>
        <button onclick="toggleAdminLogin()" class="admin-button">Admin Mode</button>
      </div>
    </div>
    
    <div id="mainContent" class="hidden">
      <p id="timestamp">Page loaded: <span id="lastUpdated"></span></p>
      
      <div class="export-options">
          <button onclick="handleExportClick('excel')" class="export-button">📊 Export to Excel</button>
          <button onclick="handleExportClick('csv')" class="export-button">📝 Export to CSV</button>
          <button onclick="handleExportClick('print')" class="export-button">🖨️ Print/PDF</button>
          <button onclick="handleExportClick('json')" class="export-button">📋 Export to JSON</button>
      </div>
      
      <div class="search-inputs">
        <div class="file-selector">
          <label for="fileSelect">📁 Select Files:</label>
          <select id="fileSelect">
            <option value="" selected disabled>-- Select files to search --</option>
            <option value="all">All Files</option>
          </select>
        </div>
        <input type="text" id="searchInput" placeholder="Search keywords separated by commas..." />
      </div>
      
      <div class="button-group">
        <button onclick="performSearch()" class="search-button">Search</button>
        <button onclick="toggleAdminLogin()" class="admin-button">Admin Mode</button>
        <button onclick="logout()" class="logout-button">Logout</button>
      </div>

      <div id="results" class="hidden">
        <p><strong>Excel Sources Loaded:</strong> <span id="excelUploadDate">Fetching...</span></p>
        <p>Total Matches: <span id="totalMatches">0</span></p>
        <p id="perTermMatches"></p>
        <h3>🔎 Search Results</h3>
        
        <div class="table-container">
          <div id="resultText"></div>
        </div>
      </div>
    </div>

    <div id="adminLogin" class="hidden">
      <h3>🔐 Admin Login</h3>
      <input type="text" id="adminUser" placeholder="Username" />
      <input type="password" id="adminPass" placeholder="Password" />
      <div class="button-group">
        <button onclick="checkAdminLogin()">Login</button>
        <button onclick="toggleAdminLogin()" class="logout-button">Cancel</button>
      </div>
    </div>

    <div id="adminPanel" class="hidden">
      <h3 class="admin-header">📋 Admin Panel - User Activity Logs</h3>
      <button onclick="hideAdminPanel()" class="logout-button" style="margin-bottom: 15px;">Close Admin Panel</button>
      
      <div class="admin-tools">
        <h3 class="admin-header">🛠️ Admin Tools</h3>
        <div class="button-group">
          <button onclick="exportUserLogs()">📝 Export Logs as Text</button>
          <button onclick="showDeleteConfirmation()" class="logout-button">🗑️ Delete All Logs</button>
        </div>
        
        <div class="selection-controls">
          <label><input type="checkbox" id="selectAllLogs" onchange="toggleSelectAllLogs(this.checked)"> Select All</label>
        </div>
        
        <div id="deleteSelectedContainer" class="delete-selected-container hidden">
          <p><strong><span id="selectedCount">0</span> log(s) selected</strong></p>
          <button onclick="deleteSelectedLogs()" class="logout-button">🗑️ Delete Selected</button>
        </div>
        
        <div id="deleteConfirmation" class="password-prompt hidden">
          <h4>Confirm Deletion</h4>
          <p>This will permanently delete all selected user logs. This action cannot be undone.</p>
          <input type="password" id="deletePassword" placeholder="Enter admin password to confirm" />
          <div class="button-group">
            <button onclick="deleteAllLogs()" class="logout-button">Confirm Delete All</button>
            <button onclick="hideDeleteConfirmation()">Cancel</button>
          </div>
        </div>
      </div>
      
      <div class="table-container">
        <table id="adminLogsTable">
          <thead>
            <tr>
              <th>Select</th>
              <th>User Name</th>
              <th>Login Time</th>
              <th>Logout Time</th>
              <th>Duration</th>
              <th>Search Count</th>
              <th>Last Search</th>
            </tr>
          </thead>
          <tbody id="logTable"></tbody>
        </table>
      </div>

      <div class="admin-section">
        <h3 class="admin-header">📁 File Management - Set Nicknames</h3>
        <div id="fileNicknameManager">
          </div>
        <div class="button-group">
          <button onclick="saveFileNicknames()">💾 Save Nicknames</button>
          <button onclick="resetFileNicknames()" class="logout-button">🔄 Reset to Default</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Theme Panel -->
  <div id="themePanel">
    <h3>🎨 Customize Theme</h3>
    
    <div class="theme-option">
      <label for="bgColor">Background Color 1:</label>
      <input type="color" id="bgColor" value="#f0f8ff">
      <span class="color-preview" id="bgPreview"></span>
    </div>
    
    <div class="theme-option">
      <label for="bgColor2">Background Color 2:</label>
      <input type="color" id="bgColor2" value="#e6f7ff">
      <span class="color-preview" id="bgPreview2"></span>
    </div>
    
    <div class="theme-option">
      <label for="textColor">Text Color:</label>
      <input type="color" id="textColor" value="#333333">
      <span class="color-preview" id="textPreview"></span>
    </div>
    
    <div class="theme-option">
      <label for="buttonColor">Button Color:</label>
      <input type="color" id="buttonColor" value="#007acc">
      <span class="color-preview" id="buttonPreview"></span>
    </div>
    
    <div class="theme-option">
      <label for="headerColor">Header Color:</label>
      <input type="color" id="headerColor" value="#007acc">
      <span class="color-preview" id="headerPreview"></span>
    </div>
    
    <div class="theme-option">
      <label for="fontFamily">Font Family:</label>
      <select id="fontFamily">
        <option value="'Segoe UI', sans-serif">Segoe UI</option>
        <option value="Arial, sans-serif">Arial</option>
        <option value="'Times New Roman', serif">Times New Roman</option>
        <option value="'Courier New', monospace">Courier New</option>
        <option value="Georgia, serif">Georgia</option>
        <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
        <option value="Verdana, sans-serif">Verdana</option>
      </select>
    </div>
    
    <h4>Preset Themes:</h4>
    <div class="preset-themes">
      <div class="preset-theme light" onclick="applyPreset('light')" title="Light Theme"></div>
      <div class="preset-theme dark" onclick="applyPreset('dark')" title="Dark Theme"></div>
      <div class="preset-theme warm" onclick="applyPreset('warm')" title="Warm Theme"></div>
      <div class="preset-theme cool" onclick="applyPreset('cool')" title="Cool Theme"></div>
      <div class="preset-theme nature" onclick="applyPreset('nature')" title="Nature Theme"></div>
      <div class="preset-theme sunset" onclick="applyPreset('sunset')" title="Sunset Theme"></div>
    </div>
    
    <div class="button-group" style="margin-top: 20px;">
      <button onclick="saveTheme()">💾 Save Theme</button>
      <button onclick="resetTheme()" class="logout-button">🔄 Reset to Default</button>
      <button onclick="toggleThemePanel()" class="logout-button">Close</button>
    </div>
  </div>
  
  <button class="theme-toggle" onclick="toggleThemePanel()">🎨</button>

  <!-- Export Preview Modal -->
  <div id="exportModal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeExportPreview()">&times;</span>
      <h3>Export Preview (<span id="previewType"></span>)</h3>
      <p id="previewMessage"></p>
      <div id="previewTableContainer"></div>
      <div class="modal-actions">
        <button onclick="closeExportPreview()">Cancel</button>
        <button id="confirmExportBtn">Confirm Export</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    // Global variables
    let excelData = [];
    let availableFiles = [];
    let fileNicknames = {};
    let searchLogs = [];
    let userSessions = [];
    let currentResults = [];
    let currentUserName = "";
    let currentUserLoginTime = null;
    let userSearchCount = 0;
    let userLastSearch = "";
    const highlightColors = ["highlight-0", "highlight-1", "highlight-2", "highlight-3", "highlight-4", "highlight-5"];
    let sortColumn = null;
    let sortDirection = 'asc';
    let selectedLogs = new Set();
    let isResizing = false;
    let currentResizeHeader = null;
    let startX = 0;
    let startWidth = 0;
    let currentExportType = null;

    // Theme customization functions
    function toggleThemePanel() {
      document.getElementById('themePanel').classList.toggle('open');
    }
    
    function loadTheme() {
      const savedTheme = localStorage.getItem('userTheme');
      if (savedTheme) {
        const theme = JSON.parse(savedTheme);
        applyTheme(theme);
        
        // Set form values to match current theme
        document.getElementById('bgColor').value = theme.bgColor;
        document.getElementById('bgColor2').value = theme.bgColor2;
        document.getElementById('textColor').value = theme.textColor;
        document.getElementById('buttonColor').value = theme.buttonColor;
        document.getElementById('headerColor').value = theme.headerColor;
        document.getElementById('fontFamily').value = theme.fontFamily;
        
        updateColorPreviews();
      }
    }
    
    function applyTheme(theme) {
      document.documentElement.style.setProperty('--bg-color', `linear-gradient(to right, ${theme.bgColor}, ${theme.bgColor2})`);
      document.documentElement.style.setProperty('--text-color', theme.textColor);
      document.documentElement.style.setProperty('--button-color', theme.buttonColor);
      document.documentElement.style.setProperty('--button-hover-color', adjustColor(theme.buttonColor, -30));
      document.documentElement.style.setProperty('--header-color', theme.headerColor);
      document.documentElement.style.setProperty('--font-family', theme.fontFamily);
    }
    
    function saveTheme() {
      const theme = {
        bgColor: document.getElementById('bgColor').value,
        bgColor2: document.getElementById('bgColor2').value,
        textColor: document.getElementById('textColor').value,
        buttonColor: document.getElementById('buttonColor').value,
        headerColor: document.getElementById('headerColor').value,
        fontFamily: document.getElementById('fontFamily').value
      };
      
      localStorage.setItem('userTheme', JSON.stringify(theme));
      applyTheme(theme);
      alert("Theme saved successfully!");
    }
    
    function resetTheme() {
      const defaultTheme = {
        bgColor: "#f0f8ff",
        bgColor2: "#e6f7ff",
        textColor: "#333333",
        buttonColor: "#007acc",
        headerColor: "#007acc",
        fontFamily: "'Segoe UI', sans-serif"
      };
      
      localStorage.removeItem('userTheme');
      applyTheme(defaultTheme);
      
      // Reset form values
      document.getElementById('bgColor').value = defaultTheme.bgColor;
      document.getElementById('bgColor2').value = defaultTheme.bgColor2;
      document.getElementById('textColor').value = defaultTheme.textColor;
      document.getElementById('buttonColor').value = defaultTheme.buttonColor;
      document.getElementById('headerColor').value = defaultTheme.headerColor;
      document.getElementById('fontFamily').value = defaultTheme.fontFamily;
      
      updateColorPreviews();
      
      alert("Theme reset to default!");
    }
    
    function applyPreset(presetName) {
      const presets = {
        light: {
          bgColor: "#f0f8ff",
          bgColor2: "#e6f7ff",
          textColor: "#333333",
          buttonColor: "#007acc",
          headerColor: "#007acc",
          fontFamily: "'Segoe UI', sans-serif"
        },
        dark: {
          bgColor: "#2c3e50",
          bgColor2: "#34495e",
          textColor: "#ecf0f1",
          buttonColor: "#3498db",
          headerColor: "#3498db",
          fontFamily: "Arial, sans-serif"
        },
        warm: {
          bgColor: "#fff8f0",
          bgColor2: "#fff0e6",
          textColor: "#333333",
          buttonColor: "#e67e22",
          headerColor: "#e67e22",
          fontFamily: "Georgia, serif"
        },
        cool: {
          bgColor: "#f0f0ff",
          bgColor2: "#e6e6ff",
          textColor: "#333366",
          buttonColor: "#2980b9",
          headerColor: "#2980b9",
          fontFamily: "'Courier New', monospace"
        },
        nature: {
          bgColor: "#f0fff0",
          bgColor2: "#e6ffe6",
          textColor: "#003300",
          buttonColor: "#27ae60",
          headerColor: "#27ae60",
          fontFamily: "Arial, sans-serif"
        },
        sunset: {
          bgColor: "#fff0f0",
          bgColor2: "#ffe6e6",
          textColor: "#660000",
          buttonColor: "#e74c3c",
          headerColor: "#e74c3c",
          fontFamily: "'Times New Roman', serif"
        }
      };
      
      if (presets[presetName]) {
        applyTheme(presets[presetName]);
        
        // Update form values
        document.getElementById('bgColor').value = presets[presetName].bgColor;
        document.getElementById('bgColor2').value = presets[presetName].bgColor2;
        document.getElementById('textColor').value = presets[presetName].textColor;
        document.getElementById('buttonColor').value = presets[presetName].buttonColor;
        document.getElementById('headerColor').value = presets[presetName].headerColor;
        document.getElementById('fontFamily').value = presets[presetName].fontFamily;
        
        updateColorPreviews();
      }
    }
    
    function updateColorPreviews() {
      document.getElementById('bgPreview').style.backgroundColor = document.getElementById('bgColor').value;
      document.getElementById('bgPreview2').style.backgroundColor = document.getElementById('bgColor2').value;
      document.getElementById('textPreview').style.backgroundColor = document.getElementById('textColor').value;
      document.getElementById('buttonPreview').style.backgroundColor = document.getElementById('buttonColor').value;
      document.getElementById('headerPreview').style.backgroundColor = document.getElementById('headerColor').value;
    }
    
    // Helper function to adjust color brightness
    function adjustColor(hex, percent) {
      // Remove # if present
      hex = hex.replace('#', '');
      
      // Convert to RGB
      let r = parseInt(hex.substring(0, 2), 16);
      let g = parseInt(hex.substring(2, 4), 16);
      let b = parseInt(hex.substring(4, 6), 16);
      
      // Adjust brightness
      r = Math.max(0, Math.min(255, r + percent));
      g = Math.max(0, Math.min(255, g + percent));
      b = Math.max(0, Math.min(255, b + percent));
      
      // Convert back to hex
      return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
    }

    // Remove file extension from filename
    function removeExtension(filename) {
      return filename.replace(/\.[^/.]+$/, "");
    }

    // Load file nicknames from localStorage or initialize empty object
    function loadFileNicknames() {
      const savedNicknames = localStorage.getItem('fileNicknames');
      if (savedNicknames) {
        fileNicknames = JSON.parse(savedNicknames);
      } else {
        fileNicknames = {};
      }
    }

    // Save file nicknames to localStorage
    function saveFileNicknames() {
      // Collect all nickname inputs
      const nicknameInputs = document.querySelectorAll('.nickname-input');
      nicknameInputs.forEach(input => {
        const filename = input.dataset.filename;
        const nickname = input.value.trim();
        if (nickname) {
          fileNicknames[filename] = nickname;
        } else {
          // If nickname is empty, remove it from the object
          delete fileNicknames[filename];
        }
      });
      
      // Save to localStorage
      localStorage.setItem('fileNicknames', JSON.stringify(fileNicknames));
      alert("File nicknames saved successfully!");
      
      // Update the file dropdown
      updateFileDropdown();
    }

    // Reset file nicknames to default (empty)
    function resetFileNicknames() {
      if (confirm("Are you sure you want to reset all file nicknames to their default names?")) {
        fileNicknames = {};
        localStorage.removeItem('fileNicknames');
        renderFileNicknameManager();
        updateFileDropdown();
        alert("File nicknames have been reset to default.");
      }
    }

    // Update the file selection dropdown with nicknames
    function updateFileDropdown() {
      const fileSelect = document.getElementById("fileSelect");
      
      // Clear existing options except the first two
      while (fileSelect.options.length > 2) {
        fileSelect.remove(2);
      }
      
      // Add files to dropdown with nicknames if available
      availableFiles.forEach(file => {
        const option = document.createElement("option");
        option.value = file.name;
        
        // Use nickname if available, otherwise use filename without extension
        const displayName = fileNicknames[file.name] || removeExtension(file.name);
        option.textContent = displayName;
        
        fileSelect.appendChild(option);
      });
    }

    // Show delete confirmation dialog
    function showDeleteConfirmation() {
      document.getElementById('deleteConfirmation').classList.remove('hidden');
      document.getElementById('deletePassword').focus();
    }

    // Hide delete confirmation dialog
    function hideDeleteConfirmation() {
      document.getElementById('deleteConfirmation').classList.add('hidden');
      document.getElementById('deletePassword').value = '';
    }

    // Update the selected logs count display
    function updateSelectedLogsCount() {
      const selectedCount = document.getElementById('selectedCount');
      const deleteSelectedContainer = document.getElementById('deleteSelectedContainer');
      
      selectedCount.textContent = selectedLogs.size;
      
      if (selectedLogs.size > 0) {
        deleteSelectedContainer.classList.remove('hidden');
      } else {
        deleteSelectedContainer.classList.add('hidden');
      }
    }

    // Toggle selection of all logs
    function toggleSelectAllLogs(selectAll) {
      const checkboxes = document.querySelectorAll('.log-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
        const index = parseInt(checkbox.dataset.index);
        if (selectAll) {
          selectedLogs.add(index);
        } else {
          selectedLogs.delete(index);
        }
      });
      
      // Update row styling
      document.querySelectorAll('.log-row').forEach((row, idx) => {
        if (selectAll) {
          row.classList.add('selected');
        } else {
          row.classList.remove('selected');
        }
      });
      
      updateSelectedLogsCount();
    }

    // Toggle selection of individual log
    function toggleLogSelection(checkbox, index) {
      if (checkbox.checked) {
        selectedLogs.add(index);
        checkbox.parentElement.parentElement.classList.add('selected');
      } else {
        selectedLogs.delete(index);
        checkbox.parentElement.parentElement.classList.remove('selected');
      }
      
      // Update select all checkbox
      const selectAll = document.getElementById('selectAllLogs');
      selectAll.checked = selectedLogs.size === userSessions.length;
      
      updateSelectedLogsCount();
    }

    // Delete selected logs
    function deleteSelectedLogs() {
      if (selectedLogs.size === 0) {
        alert("Please select at least one log to delete.");
        return;
      }
      
      if (!confirm(`Are you sure you want to delete ${selectedLogs.size} log(s)? This action cannot be undone.`)) {
        return;
      }
      
      // Delete selected logs (in reverse order to avoid index issues)
      const sortedIndexes = Array.from(selectedLogs).sort((a, b) => b - a);
      sortedIndexes.forEach(index => {
        userSessions.splice(index, 1);
      });
      
      // Clear selection
      selectedLogs.clear();
      document.getElementById('selectAllLogs').checked = false;
      
      // Update UI
      loadLogs();
      alert(`${sortedIndexes.length} log(s) have been deleted successfully.`);
    }

    // Delete all logs after password confirmation
    function deleteAllLogs() {
      const password = document.getElementById('deletePassword').value.trim();
      
      if (password !== "9332") {
        alert("Incorrect admin password. Deletion cancelled.");
        hideDeleteConfirmation();
        return;
      }
      
      // Clear all logs
      userSessions = [];
      searchLogs = [];
      selectedLogs.clear();
      
      // Update UI
      loadLogs();
      hideDeleteConfirmation();
      alert("All logs have been deleted successfully.");
    }

    // Export user logs as text file
    function exportUserLogs() {
      if (userSessions.length === 0) {
        alert("No user logs available to export.");
        return;
      }
      
      let textContent = "USER LOGIN HISTORY REPORT\n";
      textContent += "Generated on: " + new Date().toLocaleString() + "\n";
      textContent += "Total records: " + userSessions.length + "\n\n";
      
      textContent += "USER SESSION LOGS:\n";
      textContent += "===================\n\n";
      
      userSessions.forEach((session, index) => {
        textContent += `RECORD ${index + 1}:\n`;
        textContent += `User: ${session.user}\n`;
        textContent += `Login Time: ${session.loginTime ? session.loginTime.toLocaleString() : "N/A"}\n`;
        textContent += `Logout Time: ${session.logoutTime ? session.logoutTime.toLocaleString() : "Still logged in"}\n`;
        textContent += `Duration: ${session.duration ? formatDuration(session.duration) : "N/A"}\n`;
        textContent += `Search Count: ${session.searchCount || 0}\n`;
        textContent += `Last Search: ${session.lastSearch || "No searches"}\n`;
        textContent += "----------------------------------------\n\n";
      });
      
      // Create download link
      const blob = new Blob([textContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'user_logs_report.txt';
      document.body.appendChild(a);
      a.click();
      
      // Clean up
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    }

    function validateName(name) {
      // Only allow letters and spaces, no numbers or special characters
      return /^[A-Za-z\s]+$/.test(name);
    }

    function setUserName() {
      const userName = document.getElementById("userName").value.trim();
      const nameError = document.getElementById("nameError");
      
      if (!userName) {
        nameError.textContent = "Please enter your name";
        nameError.classList.remove("hidden");
        return;
      }
      
      if (!validateName(userName)) {
        nameError.textContent = "Please enter a valid name (letters only, no numbers or special characters)";
        nameError.classList.remove("hidden");
        return;
      }
      
      nameError.classList.add("hidden");
      currentUserName = userName;
      currentUserLoginTime = new Date();
      userSearchCount = 0;
      userLastSearch = "";
      
      document.getElementById("userAuth").classList.add("hidden");
      document.getElementById("mainContent").classList.remove("hidden");
      
      // Store user session
      userSessions.push({
        user: userName,
        loginTime: currentUserLoginTime,
        logoutTime: null,
        searchCount: 0,
        lastSearch: ""
      });
      
      // Focus on search input for immediate use
      document.getElementById("searchInput").focus();
    }
    
    function logout() {
      if (currentUserName && currentUserLoginTime) {
        const logoutTime = new Date();
        const duration = Math.round((logoutTime - currentUserLoginTime) / 1000); // in seconds
        
        // Update the user session with logout time
        const currentSession = userSessions.find(session => 
          session.user === currentUserName && session.logoutTime === null
        );
        
        if (currentSession) {
          currentSession.logoutTime = logoutTime;
          currentSession.duration = duration;
          currentSession.searchCount = userSearchCount;
          currentSession.lastSearch = userLastSearch;
        }
      }
      
      currentUserName = "";
      currentUserLoginTime = null;
      userSearchCount = 0;
      userLastSearch = "";
      
      document.getElementById("userAuth").classList.remove("hidden");
      document.getElementById("mainContent").classList.add("hidden");
      document.getElementById("adminLogin").classList.add("hidden");
      document.getElementById("adminPanel").classList.add("hidden");
      document.getElementById("userName").value = "";
      document.getElementById("userName").focus();
    }

    function toggleAdminLogin() {
      const adminLogin = document.getElementById("adminLogin");
      const mainContent = document.getElementById("mainContent");
      
      if (adminLogin.classList.contains("hidden")) {
        // Show admin login
        adminLogin.classList.remove("hidden");
        // Hide main content when admin login is shown
        if (!mainContent.classList.contains("hidden")) {
          mainContent.classList.add("hidden");
        }
        
        // Clear previous inputs
        document.getElementById("adminUser").value = "";
        document.getElementById("adminPass").value = "";
        
        // Focus on username field
        document.getElementById("adminUser").focus();
      } else {
        // Hide admin login, show main content
        adminLogin.classList.add("hidden");
        if (currentUserName) {
          mainContent.classList.remove("hidden");
        }
      }
    }
    
    function hideAdminPanel() {
      document.getElementById("adminPanel").classList.add("hidden");
      document.getElementById("mainContent").classList.remove("hidden");
      hideDeleteConfirmation();
    }

    function checkAdminLogin() { 
      const user = document.getElementById("adminUser").value.trim().toLowerCase();
      const pass = document.getElementById("adminPass").value.trim(); 
      
      // Case-insensitive username check for "shakeel"
      if (user === "shakeel" && pass === "9332") { 
        document.getElementById("adminLogin").classList.add("hidden"); 
        document.getElementById("adminPanel").classList.remove("hidden"); 
        loadLogs(); 
        renderFileNicknameManager();
      } else { 
        alert("Invalid credentials!"); 
      } 
    }

    async function loadAvailableFiles() {
      try {
        // Use GitHub API to list files in the repository
        const response = await fetch("https://api.github.com/repos/shakeelsnu/FleetData-by-Shakeel/contents/");
        const files = await response.json();
        
        // Filter for Excel files
        availableFiles = files.filter(f => f.name.endsWith(".xlsx"));
        
        // Update the file selection dropdown
        updateFileDropdown();
        
        return availableFiles;
      } catch (error) {
        console.error("Error loading available files:", error);
        document.getElementById("excelUploadDate").innerText = "❌ Failed to load file list";
        return [];
      }
    }

    async function loadSelectedExcelFiles() {
      const fileSelect = document.getElementById("fileSelect");
      const selectedValue = fileSelect.value;
      
      if (!selectedValue) {
        return;
      }
      
      // If "All Files" is selected
      const loadAll = selectedValue === "all";
      
      const filesToLoad = loadAll ? availableFiles : availableFiles.filter(f => f.name === selectedValue);
      
      excelData = [];
      let loadedNames = [];

      for (const file of filesToLoad) {
        try {
          // Get the raw file content from the repository
          const rawUrl = `https://raw.githubusercontent.com/shakeelsnu/FleetData-by-Shakeel/main/${file.name}`;
          const res = await fetch(rawUrl);
          const arrayBuffer = await res.arrayBuffer();
          const workbook = XLSX.read(arrayBuffer, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const rows = XLSX.utils.sheet_to_json(sheet);
          
          // Add filename to each row for tracking
          const rowsWithSource = rows.map(row => ({ ...row, __sourceFile: file.name }));
          excelData = excelData.concat(rowsWithSource);
          
          // Use nickname if available, otherwise use filename without extension
          const displayName = fileNicknames[file.name] || removeExtension(file.name);
          loadedNames.push(displayName);
        } catch (err) { 
          console.error("Failed loading:", file.name, err); 
        }
      }

      document.getElementById("excelUploadDate").innerText = loadedNames.length > 0 ? 
        loadedNames.join(", ") + " loaded at " + new Date().toLocaleString() : 
        "❌ No Excel files found or selected";
    }

    async function getClientIP() {
      try { 
        const response = await fetch("https://api.ipify.org?format=json"); 
        const data = await response.json(); 
        return data.ip; 
      } catch (e) { 
        return "IP not available"; 
      }
    }
    
    function getDeviceName() { 
      return navigator.userAgent || "Device name not available"; 
    }

    async function performSearch() {
      // Check if user is logged in
      if (!currentUserName) {
        alert("Please enter your name to search.");
        return;
      }

      const fileSelect = document.getElementById("fileSelect");
      if (!fileSelect.value) {
          alert("Please select a file to search.");
          return;
      }
      
      // First load the selected files
      await loadSelectedExcelFiles();
      
      const input = document.getElementById("searchInput").value.trim();
      const resultText = document.getElementById("resultText");
      const resultsContainer = document.getElementById("results");
      
      if (!input) { 
        resultText.innerHTML = "<p>Please type something to search.</p>"; 
        resultsContainer.classList.remove("hidden"); 
        document.getElementById("totalMatches").innerText = "0"; 
        document.getElementById("perTermMatches").innerText = "";
        return; 
      }

      const terms = input.split(",").map(term => term.trim().toLowerCase());
      
      if (excelData.length === 0) { 
        resultText.innerHTML = "<p>No data loaded from GitHub. Please select a file and try again.</p>"; 
        resultsContainer.classList.remove("hidden");
        return; 
      }

      currentResults = [];
      let totalMatches = 0;
      const matchesPerTerm = new Map();
      let lineNo = 1;

      excelData.forEach(row => {
        let rowMatched = false;
        let formattedRow = { lineNo: lineNo };
        let rowData = {};

        // Add line number to row data
        rowData['Line No'] = lineNo;
        
        // Use nickname if available, otherwise use filename without extension
        const sourceFileName = row.__sourceFile || 'Unknown';
        const displaySource = fileNicknames[sourceFileName] || removeExtension(sourceFileName);
        rowData['Source File'] = displaySource;
        
        Object.keys(row).forEach(key => {
          // Skip the internal source file property
          if (key === '__sourceFile') return;
          
          let cell = String(row[key] || "");
          let originalCell = cell;
          
          terms.forEach((term, idx) => {
            const regex = new RegExp(`(${term})`, "gi");
            if (regex.test(cell)) {
              rowMatched = true;
              cell = cell.replace(regex, `<span class='${highlightColors[idx % highlightColors.length]}'>$1</span>`);
              matchesPerTerm.set(term, (matchesPerTerm.get(term) || 0) + 1);
              totalMatches++;
            }
          });
          
          rowData[key] = cell;
          formattedRow[key] = originalCell; // Store original value for sorting
        });
        
        if (rowMatched) {
          currentResults.push({ display: rowData, sortData: formattedRow, lineNo: lineNo });
          lineNo++;
        }
      });

      document.getElementById("totalMatches").innerText = totalMatches;

      if (matchesPerTerm.size > 0) {
        const termStrings = [];
        matchesPerTerm.forEach((count, term) => {
          const colorClass = highlightColors[terms.indexOf(term) % highlightColors.length];
          termStrings.push(`<span class='${colorClass}'><b>${term}</b></span>: ${count}`);
        });
        document.getElementById("perTermMatches").innerHTML = "Matches per keyword: " + termStrings.join(", ");
      } else { 
        document.getElementById("perTermMatches").innerHTML = "No keywords matched."; 
      }
      
      renderResultsTable();
      resultsContainer.classList.remove("hidden");

      const ip = await getClientIP();
      const device = getDeviceName();
      searchLogs.push({ user: currentUserName, ip, device, time: new Date().toLocaleString(), query: input });
      
      // Update user search stats
      userSearchCount++;
      userLastSearch = input;
    }

    function renderResultsTable() {
      const resultText = document.getElementById("resultText");
      
      if (currentResults.length === 0) {
        resultText.innerHTML = "<p>No matches found.</p>";
        return;
      }
      
      // Get column headers from first result, including Source File
      // Make sure we include all columns that exist in the data
      const headers = new Set(['Line No', 'Source File']);
      
      // Add all other column names from the data
      currentResults.forEach(result => {
        Object.keys(result.sortData).forEach(key => {
          if (key !== 'lineNo' && key !== '__sourceFile') {
            headers.add(key);
          }
        });
      });
      
      let tableHtml = `<table><thead><tr>`;
      headers.forEach(header => {
        const isSorted = header === sortColumn;
        const sortClass = isSorted ? (sortDirection === 'asc' ? 'asc' : 'desc') : '';
        tableHtml += `<th class="${sortClass}" onclick="sortTable('${header}')">${header}</th>`;
      });
      tableHtml += `</tr></thead><tbody>`;
      
      currentResults.forEach((result) => {
        tableHtml += `<tr>`;
        headers.forEach(header => {
          if (header === 'Line No') {
            tableHtml += `<td>${result.lineNo}</td>`;
          } else if (header === 'Source File') {
            tableHtml += `<td>${result.display['Source File'] || ''}</td>`;
          } else {
            // Use the display version which has highlights
            tableHtml += `<td>${result.display[header] || ''}</td>`;
          }
        });
        tableHtml += `</tr>`;
      });
      
      tableHtml += `</tbody></table>`;
      resultText.innerHTML = tableHtml;
    }

    function sortTable(column) {
      if (sortColumn === column) {
        // Toggle direction if same column clicked again
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        sortColumn = column;
        sortDirection = 'asc';
      }
      
      currentResults.sort((a, b) => {
        let valueA, valueB;
        
        if (column === 'Line No') {
          valueA = a.lineNo;
          valueB = b.lineNo;
        } else if (column === 'Source File') {
            valueA = a.display['Source File'] || '';
            valueB = b.display['Source File'] || '';
        } else {
          // Use the sortData which contains the original values (without HTML)
          valueA = a.sortData[column] || '';
          valueB = b.sortData[column] || '';
        }
        
        // Convert to numbers if possible for proper numeric sorting
        // Handle numbers with commas
        const numA = typeof valueA === 'string' ? 
          parseFloat(valueA.toString().replace(/,/g, '')) : parseFloat(valueA);
        const numB = typeof valueB === 'string' ? 
          parseFloat(valueB.toString().replace(/,/g, '')) : parseFloat(valueB);
        
        if (!isNaN(numA) && !isNaN(numB)) {
          // Both values are numeric, compare as numbers
          valueA = numA;
          valueB = numB;
        } else {
          // At least one value is not numeric, compare as strings
          valueA = String(valueA || '').toLowerCase();
          valueB = String(valueB || '').toLowerCase();
        }
        
        if (valueA < valueB) return sortDirection === 'asc' ? -1 : 1;
        if (valueA > valueB) return sortDirection === 'asc' ? 1 : -1;
        return 0;
      });
      
      renderResultsTable();
    }
    
    function handleExportClick(type) {
      if (currentResults.length === 0) {
        alert("Please perform a search first to get results.");
        return;
      }
      showExportPreview(type);
    }
    
    // Export and Preview Functions
    function showExportPreview(type) {
        currentExportType = type;
        const modal = document.getElementById('exportModal');
        const previewType = document.getElementById('previewType');
        const previewTableContainer = document.getElementById('previewTableContainer');
        const confirmBtn = document.getElementById('confirmExportBtn');
        const previewMessage = document.getElementById('previewMessage');

        previewType.textContent = type.toUpperCase();
        previewTableContainer.innerHTML = '';
        
        // Prepare data for preview (use plain text version)
        const headers = Array.from(new Set(['Line No', 'Source File', ...Object.keys(currentResults[0].sortData)
          .filter(key => key !== 'lineNo' && key !== '__sourceFile')]));
        
        let previewHtml = `<table><thead><tr>`;
        headers.forEach(header => {
            previewHtml += `<th>${header}</th>`;
        });
        previewHtml += `</tr></thead><tbody>`;
        
        currentResults.forEach(result => {
            previewHtml += `<tr>`;
            headers.forEach(header => {
                if (header === 'Line No') {
                    previewHtml += `<td>${result.lineNo}</td>`;
                } else if (header === 'Source File') {
                    previewHtml += `<td>${result.display['Source File'] || ''}</td>`;
                } else {
                    const value = String(result.sortData[header] || '').replace(/<[^>]*>/g, '');
                    previewHtml += `<td>${value}</td>`;
                }
            });
            previewHtml += `</tr>`;
        });
        previewHtml += `</tbody></table>`;
        
        previewTableContainer.innerHTML = previewHtml;

        // Update message based on export type
        switch(type) {
            case 'excel':
                previewMessage.textContent = 'Preview of data to be exported as an Excel file (.xlsx).';
                break;
            case 'csv':
                previewMessage.textContent = 'Preview of data to be exported as a CSV file (.csv).';
                break;
            case 'json':
                previewMessage.textContent = 'Preview of data to be exported as a JSON file (.json).';
                break;
            case 'print':
                previewMessage.textContent = 'Preview of data for printing or saving as a PDF.';
                break;
        }

        // Set up the confirm button action
        confirmBtn.onclick = () => {
            if (currentExportType === 'excel') exportToExcel();
            else if (currentExportType === 'csv') exportToCSV();
            else if (currentExportType === 'json') exportToJSON();
            else if (currentExportType === 'print') printResults();
            closeExportPreview();
        };

        modal.style.display = 'block';
    }

    function closeExportPreview() {
        document.getElementById('exportModal').style.display = 'none';
    }

    function exportToExcel() { 
      const workbook = XLSX.utils.book_new(); 
      const headers = Array.from(new Set(['Line No', 'Source File', ...Object.keys(currentResults[0].sortData)
        .filter(key => key !== 'lineNo' && key !== '__sourceFile')]));
      
      const exportData = currentResults.map(result => {
        const row = {
          'Line No': result.lineNo,
          'Source File': result.display['Source File'] || ''
        };
        
        headers.forEach(header => {
          if (header !== 'Line No' && header !== 'Source File') {
            row[header] = String(result.sortData[header] || '').replace(/<[^>]*>/g, '');
          }
        });
        return row;
      });
      
      const worksheet = XLSX.utils.json_to_sheet(exportData);
      XLSX.utils.book_append_sheet(workbook, worksheet, "Search Results"); 
      XLSX.writeFile(workbook, "search_results.xlsx"); 
    }

    function exportToCSV() {
      const headers = Array.from(new Set(['Line No', 'Source File', ...Object.keys(currentResults[0].sortData)
        .filter(key => key !== 'lineNo' && key !== '__sourceFile')]));
      
      const exportData = currentResults.map(result => {
        const row = {
          'Line No': result.lineNo,
          'Source File': result.display['Source File'] || ''
        };
        
        headers.forEach(header => {
          if (header !== 'Line No' && header !== 'Source File') {
            row[header] = String(result.sortData[header] || '').replace(/<[^>]*>/g, '');
          }
        });
        return row;
      });
      
      let csvContent = headers.join(',') + '\n';
      exportData.forEach(row => {
        const values = headers.map(header => {
          let value = row[header] || '';
          value = String(value).replace(/"/g, '""');
          if (String(value).includes(',')) {
            value = `"${value}"`;
          }
          return value;
        });
        csvContent += values.join(',') + '\n';
      });
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'search_results.csv';
      document.body.appendChild(a);
      a.click();
      
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    }

    function exportToJSON() {
      const headers = Array.from(new Set(['Line No', 'Source File', ...Object.keys(currentResults[0].sortData)
        .filter(key => key !== 'lineNo' && key !== '__sourceFile')]));
      
      const exportData = currentResults.map(result => {
        const row = {
          'Line No': result.lineNo,
          'Source File': result.display['Source File'] || ''
        };
        
        headers.forEach(header => {
          if (header !== 'Line No' && header !== 'Source File') {
            row[header] = String(result.sortData[header] || '').replace(/<[^>]*>/g, '');
          }
        });
        return row;
      });
      
      const jsonContent = JSON.stringify(exportData, null, 2);
      
      const blob = new Blob([jsonContent], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'search_results.json';
      document.body.appendChild(a);
      a.click();
      
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
    }

    function printResults() { 
      const printWindow = window.open("", "", "width=800,height=600"); 
      const content = document.getElementById("resultText").innerHTML; 
      printWindow.document.write(`<html><head><title>Search Results</title><style>table { width: 100%; border-collapse: collapse; margin-bottom: 10px; } th, td { border: 1px solid #ddd; padding: 12px; text-align: left; } th { background-color: #e0f0ff; font-weight: bold; } .highlight-0 { background-color: #FFFF00; font-weight: bold; } .highlight-1 { background-color: #00FF00; font-weight: bold; } .highlight-2 { background-color: #00FFFF; font-weight: bold; } .highlight-3 { background-color: #FF00FF; font-weight: bold; color: white; } .highlight-4 { background-color: #FF8000; font-weight: bold; } .highlight-5 { background-color: #FF0080; font-weight: bold; color: white; }</style></head><body><h3>Search Results</h3>${content}</body></html>`); 
      printWindow.document.close(); 
      printWindow.focus(); 
      printWindow.print(); 
    }

    function formatDuration(seconds) {
      if (!seconds) return "N/A";
      
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      
      if (hours > 0) {
        return `${hours}h ${minutes}m ${secs}s`;
      } else if (minutes > 0) {
        return `${minutes}m ${secs}s`;
      } else {
        return `${secs}s`;
      }
    }

    function loadLogs() { 
      const logTable = document.getElementById("logTable"); 
      logTable.innerHTML = ""; 
      
      userSessions.forEach((session, index) => {
        const loginTime = session.loginTime ? session.loginTime.toLocaleString() : "N/A";
        const logoutTime = session.logoutTime ? session.logoutTime.toLocaleString() : "Still logged in";
        const duration = session.duration ? formatDuration(session.duration) : "N/A";
        const searchCount = session.searchCount || 0;
        const lastSearch = session.lastSearch || "No searches";
        
        const isSelected = selectedLogs.has(index);
        
        logTable.innerHTML += `
          <tr class="log-row ${isSelected ? 'selected' : ''}">
            <td><input type="checkbox" class="log-checkbox" data-index="${index}" ${isSelected ? 'checked' : ''} onchange="toggleLogSelection(this, ${index})"></td>
            <td>${session.user}</td>
            <td>${loginTime}</td>
            <td>${logoutTime}</td>
            <td>${duration}</td>
            <td>${searchCount}</td>
            <td>${lastSearch}</td>
          </tr>
        `;
      }); 
      
      updateSelectedLogsCount();
    }

    window.onload = async function() { 
      document.getElementById("lastUpdated").innerText = new Date().toLocaleString(); 
      
      loadFileNicknames();
      loadTheme(); // Load user's saved theme
      
      await loadAvailableFiles();
      
      document.getElementById("userName").addEventListener("keypress", function(e) { 
        if (e.key === "Enter") setUserName(); 
      });
      
      document.getElementById("searchInput").addEventListener("keypress", function(e) { 
        if (e.key === "Enter") performSearch(); 
      }); 

      document.getElementById("adminUser").addEventListener("keypress", function(e) { 
        if (e.key === "Enter") checkAdminLogin(); 
      }); 

      document.getElementById("adminPass").addEventListener("keypress", function(e) { 
        if (e.key === "Enter") checkAdminLogin(); 
      }); 

      document.getElementById("deletePassword").addEventListener("keypress", function(e) { 
        if (e.key === "Enter") deleteAllLogs(); 
      }); 

      // Add event listeners for theme customization
      document.getElementById('bgColor').addEventListener('input', updateColorPreviews);
      document.getElementById('bgColor2').addEventListener('input', updateColorPreviews);
      document.getElementById('textColor').addEventListener('input', updateColorPreviews);
      document.getElementById('buttonColor').addEventListener('input', updateColorPreviews);
      document.getElementById('headerColor').addEventListener('input', updateColorPreviews);
      
      // Initial preview update
      updateColorPreviews();

      window.onclick = function(event) {
        const modal = document.getElementById('exportModal');
        if (event.target == modal) {
          modal.style.display = 'none';
        }
      }
    };
  </script>
</body>
</html>
